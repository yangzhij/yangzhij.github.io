<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">










<meta name="description" content="愿一生温暖纯良">
<meta property="og:type" content="website">
<meta property="og:title" content="yangzhijun">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="yangzhijun">
<meta property="og:description" content="愿一生温暖纯良">
<meta property="og:locale" content="default">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="yangzhijun">
<meta name="twitter:description" content="愿一生温暖纯良">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/">





  <title>yangzhijun</title>
  








</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="default">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">yangzhijun</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">在你觉得幸福时，请别忘了安静地守护别人的幸福。</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            Archives
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/07/04/centos7部署NextCloud/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="yangzhijun">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://raw.githubusercontent.com/yangzhij/images2/master/1.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yangzhijun">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/07/04/centos7部署NextCloud/" itemprop="url">centos7部署NextCloud</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-07-04T14:15:30+08:00">
                2019-07-04
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>//检查下列服务若自带则卸载（rpm -e … –nodeps）<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rpm -qa|grep php</span><br><span class="line">rpm -qa|grep php-common</span><br><span class="line">rpm -qa|grep nginx</span><br></pre></td></tr></table></figure></p>
<p>//安装相关组件；并检查php-fpm是否已正常安装<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">yum -y install epel-release</span><br><span class="line">yum -y install nginx</span><br><span class="line">rpm -Uvh https://mirror.webtatic.com/yum/el7/webtatic-release.rpm</span><br><span class="line">yum -y install php70w-fpm php70w-cli php70w-gd php70w-mcrypt php70w-mysql php70w-pear php70w-xml php70w-mbstring php70w-pdo php70w-json php70w-pecl-apcu php70w-pecl-apcu-devel</span><br><span class="line">php -v</span><br></pre></td></tr></table></figure></p>
<p>配置php-fpm<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sed -i &apos;s/user = apache/user = nginx/&apos; /etc/php-fpm.d/www.conf</span><br><span class="line">sed -i &apos;s/group = apache/group = nginx/&apos; /etc/php-fpm.d/www.conf</span><br><span class="line">sed -i &apos;s/;env/env/g&apos; /etc/php-fpm.d/www.conf</span><br></pre></td></tr></table></figure></p>
<p>在/var/lib目录下为session路径创建一个新的文件夹，并将用户名和组设为nginx<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /var/lib/php/session</span><br><span class="line">chown nginx:nginx -R /var/lib/php/session/</span><br><span class="line">ll -d /var/lib/php/session/</span><br></pre></td></tr></table></figure></p>
<p>启动Nginx和php-fpm服务，并添加开机启动<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">systemctl start php-fpm</span><br><span class="line">systemctl start nginx</span><br><span class="line">systemctl enable php-fpm</span><br><span class="line">systemctl enable nginx</span><br></pre></td></tr></table></figure></p>
<p>安装并配置MariaDB,启动并添加开机启动<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum -y install mariadb mariadb-server</span><br><span class="line">systemctl start mariadb</span><br><span class="line">systemctl enable mariadb</span><br></pre></td></tr></table></figure></p>
<p>//接下来设置MariaDB的root密码<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@nextcloud-server ~]# mysql_secure_installation        //按照提示设置密码，首先会询问当前密码，密码默认为空，直接回车即可</span><br><span class="line">Enter current password for root (enter for none):          //直接回车</span><br><span class="line">Set root password? [Y/n] Y</span><br><span class="line">New password:                                              //输入新密码</span><br><span class="line">Re-enter new password:                                     //再次输入新密码</span><br><span class="line">     </span><br><span class="line">Remove anonymous users? [Y/n] Y</span><br><span class="line">Disallow root login remotely? [Y/n] Y</span><br><span class="line">Remove test database and access to it? [Y/n] Y</span><br><span class="line">Reload privilege tables now? [Y/n] Y</span><br></pre></td></tr></table></figure></p>
<p>//进入mysql   并为Nextcloud创建相应的用户和数据库。例如数据库为nextcloud_db，用户为nextclouduser，密码为cloudpasswd<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# mysql -p</span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt; create database nextcloud_db;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt; create user nextclouduser@localhost identified by &apos;cloudpasswd&apos;;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt; grant all privileges on nextcloud_db.* to nextclouduser@localhost identified by &apos;cloudpasswd&apos;;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt; flush privileges;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt; exit</span><br></pre></td></tr></table></figure></p>
<p>//为Nextcloud生成自签名SSL证书<br>为SSL证书创建一个新的文件夹，然后将证书文件的权限设置为660<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# mkdir /etc/nginx/cert/ &amp;&amp; cd /etc/nginx/cert/</span><br><span class="line">[root@localhost ~]# openssl req -new -x509 -days 365 -nodes -out /etc/nginx/cert/nextcloud.crt -keyout /etc/nginx/cert/nextcloud.key</span><br><span class="line"></span><br><span class="line">Country Name (2 letter code) [XX]:cn                                           //国家</span><br><span class="line">State or Province Name (full name) []:beijing                                  //省份</span><br><span class="line">Locality Name (eg, city) [Default City]:beijing                                //地区名字</span><br><span class="line">Organization Name (eg, company) [Default Company Ltd]:weiruan                       //公司名</span><br><span class="line">Organizational Unit Name (eg, section) []:IT                           //部门</span><br><span class="line">Common Name (eg, your name or your server&apos;s hostname) []:weiruan                 //CA主机名</span><br><span class="line">Email Address []:weiruan@gmail.com           </span><br><span class="line"></span><br><span class="line">chmod 700 /etc/nginx/cert</span><br><span class="line">chmod 600 /etc/nginx/cert/*</span><br></pre></td></tr></table></figure></p>
<p>//下载并安装Nextcloud<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">yum -y install wget unzip</span><br><span class="line">cd /usr/local/src/</span><br><span class="line">wget https://download.nextcloud.com/server/releases/nextcloud-12.0.4.zip</span><br><span class="line">unzip nextcloud-12.0.4.zip</span><br><span class="line">mv nextcloud /usr/share/nginx/html/</span><br><span class="line">cd /usr/share/nginx/html/</span><br><span class="line">mkdir -p nextcloud/data/</span><br><span class="line">chown nginx:nginx -R nextcloud/</span><br></pre></td></tr></table></figure></p>
<p>//设置Nginx虚拟主机<br>进入Nginx的虚拟主机配置文件所在目录并创建一个新的虚拟主机配置（记得修改两个server_name为自己的域名）<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# cd /etc/nginx/conf.d/ </span><br><span class="line">[root@localhost ~]# vim nextcloud.conf      //复制下面内容</span><br><span class="line"></span><br><span class="line">upstream php-handler &#123;</span><br><span class="line">    server 127.0.0.1:9000;</span><br><span class="line">&#125;</span><br><span class="line">     </span><br><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name nextcloud.remy.com;</span><br><span class="line">    return 301 https://$server_name$request_uri;</span><br><span class="line">&#125;</span><br><span class="line">     </span><br><span class="line">server &#123;</span><br><span class="line">    listen 443 ssl;</span><br><span class="line">    server_name nextcloud.remy.com;</span><br><span class="line">     </span><br><span class="line">    ssl_certificate /etc/nginx/cert/nextcloud.crt;</span><br><span class="line">    ssl_certificate_key /etc/nginx/cert/nextcloud.key;</span><br><span class="line">     </span><br><span class="line">    add_header Strict-Transport-Security &quot;max-age=15768000;</span><br><span class="line">    includeSubDomains; preload;&quot;;</span><br><span class="line">    add_header X-Content-Type-Options nosniff;</span><br><span class="line">    add_header X-Frame-Options &quot;SAMEORIGIN&quot;;</span><br><span class="line">    add_header X-XSS-Protection &quot;1; mode=block&quot;;</span><br><span class="line">    add_header X-Robots-Tag none;</span><br><span class="line">    add_header X-Download-Options noopen;</span><br><span class="line">    add_header X-Permitted-Cross-Domain-Policies none;</span><br><span class="line">     </span><br><span class="line">    # Path to the root of your installation</span><br><span class="line">    root /usr/share/nginx/html/nextcloud/;</span><br><span class="line">     </span><br><span class="line">    location = /robots.txt &#123;</span><br><span class="line">        allow all;</span><br><span class="line">        log_not_found off;</span><br><span class="line">        access_log off;</span><br><span class="line">    &#125;</span><br><span class="line">     </span><br><span class="line">    location = /.well-known/carddav &#123;</span><br><span class="line">      return 301 $scheme://$host/remote.php/dav;</span><br><span class="line">    &#125;</span><br><span class="line">    location = /.well-known/caldav &#123;</span><br><span class="line">      return 301 $scheme://$host/remote.php/dav;</span><br><span class="line">    &#125;</span><br><span class="line">     </span><br><span class="line">    # set max upload size</span><br><span class="line">    client_max_body_size 512M;</span><br><span class="line">    fastcgi_buffers 64 4K;</span><br><span class="line">     </span><br><span class="line">    # Disable gzip to avoid the removal of the ETag header</span><br><span class="line">    gzip off;</span><br><span class="line"></span><br><span class="line">     </span><br><span class="line">    error_page 403 /core/templates/403.php;</span><br><span class="line">    error_page 404 /core/templates/404.php;</span><br><span class="line">     </span><br><span class="line">    location / &#123;</span><br><span class="line">        rewrite ^ /index.php$uri;</span><br><span class="line">    &#125;</span><br><span class="line">     </span><br><span class="line">    location ~ ^/(?:build|tests|config|lib|3rdparty|templates|data)/ &#123;</span><br><span class="line">        deny all;</span><br><span class="line">    &#125;</span><br><span class="line">    location ~ ^/(?:\.|autotest|occ|issue|indie|db_|console) &#123;</span><br><span class="line">        deny all;</span><br><span class="line">    &#125;</span><br><span class="line">     </span><br><span class="line">    location ~ ^/(?:index|remote|public|cron|core/ajax/update|status|ocs/v[12]|updater/.+|ocs-provider/.+|core/templates/40[34])\.php(?:$|/) &#123;</span><br><span class="line">        include fastcgi_params;</span><br><span class="line">        fastcgi_split_path_info ^(.+\.php)(/.*)$;</span><br><span class="line">        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;</span><br><span class="line">        fastcgi_param PATH_INFO $fastcgi_path_info;</span><br><span class="line">        fastcgi_param HTTPS on;</span><br><span class="line">        #Avoid sending the security headers twice</span><br><span class="line">        fastcgi_param modHeadersAvailable true;</span><br><span class="line">        fastcgi_param front_controller_active true;</span><br><span class="line">        fastcgi_pass php-handler;</span><br><span class="line">        fastcgi_intercept_errors on;</span><br><span class="line">        fastcgi_request_buffering off;</span><br><span class="line">    &#125;</span><br><span class="line">     </span><br><span class="line">    location ~ ^/(?:updater|ocs-provider)(?:$|/) &#123;</span><br><span class="line">        try_files $uri/ =404;</span><br><span class="line">        index index.php;</span><br><span class="line">    &#125;</span><br><span class="line">     </span><br><span class="line">    location ~* \.(?:css|js)$ &#123;</span><br><span class="line">        try_files $uri /index.php$uri$is_args$args;</span><br><span class="line">        add_header Cache-Control &quot;public, max-age=7200&quot;;</span><br><span class="line">        # Add headers to serve security related headers (It is intended to</span><br><span class="line">        # have those duplicated to the ones above)</span><br><span class="line">        # Before enabling Strict-Transport-Security headers please read into</span><br><span class="line">        # this topic first.</span><br><span class="line">        add_header Strict-Transport-Security &quot;max-age=15768000;includeSubDomains; preload;&quot;;</span><br><span class="line">        add_header X-Content-Type-Options nosniff;</span><br><span class="line">        add_header X-Frame-Options &quot;SAMEORIGIN&quot;;</span><br><span class="line">        add_header X-XSS-Protection &quot;1; mode=block&quot;;</span><br><span class="line">        add_header X-Robots-Tag none;</span><br><span class="line">        add_header X-Download-Options noopen;</span><br><span class="line">        add_header X-Permitted-Cross-Domain-Policies none;</span><br><span class="line">        # Optional: Don&apos;t log access to assets</span><br><span class="line">        access_log off;</span><br><span class="line">    &#125;</span><br><span class="line">     </span><br><span class="line">    location ~* \.(?:svg|gif|png|html|ttf|woff|ico|jpg|jpeg)$ &#123;</span><br><span class="line">        try_files $uri /index.php$uri$is_args$args;</span><br><span class="line">        # Optional: Don&apos;t log access to other assets</span><br><span class="line">        access_log off;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>//测试配置文件是否有误，确保没有问题后重启Nginx服务。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost conf.d]# nginx -t</span><br><span class="line">[root@localhost conf.d]# nginx -s reload</span><br><span class="line">[root@localhost conf.d]# systemctl restart nginx</span><br></pre></td></tr></table></figure></p>
<p>//nextcloud上传文件大小的自身限制为512M，修改php.ini上传文件大小限制<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sed -i &apos;s/max_execution_time = 30/max_execution_time = 0/&apos; /etc/php.ini</span><br><span class="line">sed -i &apos;s/post_max_size = 8M/post_max_size = 10800M/&apos; /etc/php.ini</span><br><span class="line">sed -i &apos;s/upload_max_filesize = 2M/upload_max_filesize = 10240M/&apos; /etc/php.ini</span><br></pre></td></tr></table></figure></p>
<p>//解析上面nginx中配置的域名nextcloud.remy.com，浏览器访问nextcloud.remy.com进行Nextcloud界面安装</p>
<p>参考<a href="https://www.cnblogs.com/kevingrace/p/8343060.html" target="_blank" rel="noopener">https://www.cnblogs.com/kevingrace/p/8343060.html</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/06/22/rsync-inotify-实现文件实时同步/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="yangzhijun">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://raw.githubusercontent.com/yangzhij/images2/master/1.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yangzhijun">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/06/22/rsync-inotify-实现文件实时同步/" itemprop="url">rsync+inotify 实现文件实时同步</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-06-22T14:58:45+08:00">
                2019-06-22
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong>rsync</strong><br>rsync首次同步数据时会把全部文件拷贝一次，使本地和远程两个主机之间的文件达到同步。之后再同步时，会扫描所有文件后进行比对，然后进行差量传输。<br>rsync具有安全性高、备份迅速、支持增量备份。可以解决对实时性要求不高的数据备份需求。如定期地备份文件服务器数据到远程服务器上，对本地磁盘定期进行数据镜像等。但，rsync不能够实时监测、同步数据。如果有这方面要求，这就需要和inotify组合，来实现数据的实时同步。</p>
<p>//提炼<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">同步本地文件：rsync -avz /data /backup</span><br><span class="line">同步本地文件到远程：</span><br><span class="line">rsync -avz /data test@192.168.199.247:/backup</span><br><span class="line">rsync -avz /data test@192.168.199.247::backup –password-file=/etc/rsyncd.password（常用推送方式）</span><br><span class="line"></span><br><span class="line">把远程机器的文件同步到本地：</span><br><span class="line">rsync -avz test@192.168.199.247:/backup /data</span><br><span class="line">rsync -avz test@192.168.199.247::backup –password-file=/etc/rsyncd.password /data  （常用拉取方式）</span><br><span class="line"></span><br><span class="line">服务端配置：</span><br><span class="line">rsync服务器端需要两个配置文件：rsyncd.conf（主配置）、rsyncd.password（密码文件，存储rsync用户名和密码）；</span><br><span class="line">但是在rsync安装完毕后后是不会生成以上这两个配置文件的，需要我们手工进行创建。</span><br><span class="line"></span><br><span class="line">通过rsync可以解决对实时性不高的数据备份需求。</span><br><span class="line">缺点：首先rsync同步数据时需要扫描所有文件后进行对比，然后差量传输，对于大数据这是非常低效的。</span><br><span class="line">其次，rsync不能时时的去检测，同步数据。基于以上原因，考虑采用rsync+inotify解决这些问题。</span><br></pre></td></tr></table></figure></p>
<p><strong>项目需求</strong><br>把公司热更服务器上的/home/wwwroot下所有目录及文件备份至文件服务器/home/wwwroot，要求实现目录实时同步。</p>
<p>热更服务器 172.20.100.155<br>文件服务器 172.20.100.115</p>
<p><strong>文件服务器操作</strong><br>//安装：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">检查rsync 是否已经安装：rpm -qa|grep rsync；若已经安装，则使用rpm -e 命令卸载(如果提示有依赖，可以加上 --nodeps)。</span><br><span class="line">yum -y install gcc</span><br><span class="line">wget https://download.samba.org/pub/rsync/rsync-3.1.3.tar.gz </span><br><span class="line">tar -xzf rsync-3.1.3.tar.gz</span><br><span class="line">cd rsync-3.1.3</span><br><span class="line">./configure</span><br><span class="line">make &amp;&amp; make install</span><br><span class="line">/usr/local/bin/rsync --daemon     //启动</span><br><span class="line">设置开机启动：echo “/usr/local/bin/rsync –daemon”&gt;&gt;/etc/rc.local</span><br></pre></td></tr></table></figure></p>
<p>//编辑配置文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/rsyncd.conf</span><br><span class="line">uid = root</span><br><span class="line">gid = root</span><br><span class="line">use chroot = yes</span><br><span class="line">max connections = 10</span><br><span class="line">strict mode=yes</span><br><span class="line">pid file = /var/run/rsyncd.pid</span><br><span class="line">lock file=/var/run/rsync.lock</span><br><span class="line">log file=/var/log/rsyncd.log</span><br><span class="line">[web1]   //模块名</span><br><span class="line">path = /home/wwwroot               //这个目录手动创建   同步的内容会放到这个目录下</span><br><span class="line">comment = web1 file</span><br><span class="line">ignore errrors</span><br><span class="line">read only=no</span><br><span class="line">write only=no</span><br><span class="line">hosts allow=*           //允许所有主机</span><br><span class="line">hosts deny=192.168.100.10    //拒绝某台主机</span><br><span class="line">list=false</span><br><span class="line">uid=root</span><br><span class="line">gid=root</span><br><span class="line">auth users=web1user          //允许用户</span><br><span class="line">secrets file=/etc/web1.pass</span><br></pre></td></tr></table></figure></p>
<p>//创建密码文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/web1.pass    格式如下</span><br><span class="line"></span><br><span class="line">web1user:admin123</span><br></pre></td></tr></table></figure></p>
<p>//修改密码文件权限<br>chmod 600 /etc/web1.pass</p>
<p><strong>热更服务器操作</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">//安装</span><br><span class="line">yum -y install gcc</span><br><span class="line">cd /usr/local/src</span><br><span class="line">wget https://download.samba.org/pub/rsync/rsync-3.1.3.tar.gz </span><br><span class="line">tar zxvf rsync-3.1.3.tar.gz -C /opt</span><br><span class="line">cd /opt/rsync-3.1.3</span><br><span class="line">./configure</span><br><span class="line">make &amp;&amp; make install</span><br><span class="line"></span><br><span class="line">生成rsync的密码文件</span><br><span class="line">vim /etc/server.pass   直接把密码放里面，保存即可</span><br><span class="line"></span><br><span class="line">admin123</span><br><span class="line"></span><br><span class="line">//权限</span><br><span class="line">chmod 600 /etc/server.pass</span><br></pre></td></tr></table></figure></p>
<p><strong>先测试一下~~~</strong><br>把热更上/home/wwwroot   同步到远程机器上<br>·<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">rsync -vzrtopg --progress --delete /home/wwwroot web1user@172.20.100.115::web1 --password-file=/etc/server.pass</span><br><span class="line"></span><br><span class="line">//解释</span><br><span class="line">--progress是指显示出详细的进度情况</span><br><span class="line">--delete是指如果服务器端删除了这一文件，那么客户端也相应把文件删除，保持真正的一致。</span><br><span class="line">--password-file来指定密码文件</span><br><span class="line">web1user@172.20.100.115::web1    用户名@ip::模块名</span><br></pre></td></tr></table></figure></p>
<p>//inotify 下载安装<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">wget http://github.com/downloads/rvoicilas/inotify-tools/inotify-tools-3.14.tar.gz</span><br><span class="line">tar zxvf inotify-tools-3.14.tar.gz -C /opt</span><br><span class="line">cd -C /opt/inotify-tools-3.14</span><br><span class="line">cd /opt/inotify-tools-3.14</span><br><span class="line">./configure</span><br><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure></p>
<p>//修改内核的inotify参数<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/sysctl.conf </span><br><span class="line"></span><br><span class="line">fs.inotify.max_user_instances = 65535</span><br><span class="line">fs.inotify.max_user_watches = 6553500         监控的文件数量很大时，对应的数值需要修改</span><br><span class="line">fs.inotify.max_queued_events = 6553500</span><br><span class="line"></span><br><span class="line">sysctl -p       #让上述修改立刻生效</span><br></pre></td></tr></table></figure></p>
<p>//写脚本来监控热更机器/home/wwwroot/ 目录<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">vim /web/inotifyrsync.sh</span><br><span class="line"></span><br><span class="line">#!/bin/bash</span><br><span class="line">host1=172.20.100.155         // 热更服务器</span><br><span class="line">src=/home/wwwroot/           // 监控目录</span><br><span class="line">mokuai=web1</span><br><span class="line">user1=web1user</span><br><span class="line">/usr/local/bin/inotifywait -mrq --timefmt &apos;%d/%m/%y %H:%M&apos; --format &apos;%T %w%f%e&apos; -e close_write,delete,create,attrib $src \</span><br><span class="line">| while read files</span><br><span class="line">do</span><br><span class="line">        rsync -vzrtopg --progress --delete $src --password-file=/etc/server.pass  $user1@$host1::$mokuai &gt; /dev/null 2&gt;&amp;1</span><br><span class="line">        echo &quot;$&#123;files&#125; was rsynced.&quot; &gt;&gt; /tmp/rsync.log 2&gt;&amp;1</span><br><span class="line">done</span><br></pre></td></tr></table></figure></p>
<p>//测试脚本<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">chmod 755 /web/inotifyrsync.sh</span><br><span class="line">/web/inotifyrsync.sh &amp;</span><br></pre></td></tr></table></figure></p>
<p>//开机启动脚本<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo &quot;/web/inotifyrsync.sh &amp;&quot; &gt;&gt; /etc/rc.local</span><br></pre></td></tr></table></figure></p>
<p>然后测试下看能否同步……</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/06/20/Tomcat安装及优化/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="yangzhijun">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://raw.githubusercontent.com/yangzhij/images2/master/1.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yangzhijun">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/06/20/Tomcat安装及优化/" itemprop="url">Tomcat安装及优化</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-06-20T16:36:28+08:00">
                2019-06-20
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>~~很简单的，闲的没事就写一下喽<br>//安装前提<br>须有java及其环境变量, 安装配置见linux一些基础</p>
<p>//安装<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">cd /home</span><br><span class="line">wget http://mirrors.tuna.tsinghua.edu.cn/apache/tomcat/tomcat-9/v9.0.14/bin/apache-tomcat-9.0.14.tar.gz</span><br><span class="line">tar zxvf apache-tomcat-9.0.14.tar.gz </span><br><span class="line">mv apache-tomcat-9.0.14 Jenkinstomcat          //可以把目录改个名字，便于区分</span><br><span class="line">cd Jenkinstomcat/conf/</span><br><span class="line">vi server.xml #有需要修改Tomcat端口,例如改为83端口   </span><br><span class="line">sed -i &apos;s/Connector port=&quot;8080&quot;/Connector port=&quot;83&quot;/&apos; /home/Jenkinstomcat/conf/server.xml  </span><br><span class="line">cd ../webapps/</span><br><span class="line">项目是放到这个目录下的</span><br><span class="line">cd ../bin/</span><br><span class="line">./startup.sh</span><br></pre></td></tr></table></figure></p>
<p>注：在一台机器上运行多个Tomcat实例，就把目录名改一下，server.xml里端口改一下，分别启动就ok了</p>
<p>//优化<br>Tomcat一般来讲做优化的话，除了机器本身优化(见linux基本优化),还有就是Tomcat容器内（conf目录下server.xml）针对吞吐量做优化，就是一些连接参数的优化.</p>
<pre><code>&lt;Connector port=&quot;83&quot; protocol=&quot;HTTP/1.1&quot;          
    URIEncoding=&quot;UTF-8&quot;            
    minSpareThreads=&quot;25&quot;    #表示即使没有人使用也开这么多空线程等待       
    maxSpareThreads=&quot;75&quot;    #表示即使没有人使用也开这么多空线程等待      
    enableLookups=&quot;false&quot;         #是否反查域名，取值为：true或false。为了提高处理能力，应设置为false  
    disableUploadTimeout=&quot;true&quot;           
    connectionTimeout=&quot;20000&quot;      #网络连接超时，单位：毫秒。 设置为0表示永不超时，这样设置有隐患的。   
    acceptCount=&quot;300&quot;     #当同时连接的人数达到maxThreads时，还可以接收排队的连接，超过这个连接数则直接返回拒绝连接。       
    maxThreads=&quot;300&quot;         #表示最多同时处理300个连接  
    maxProcessors=&quot;1000&quot;     #最大连接线程数，即：并发处理的最大请求数，    
    minProcessors=&quot;5&quot;        #最小空闲连接线程数，用于提高系统处理性能        
    useURIValidationHack=&quot;false&quot;        #设置为false，可以减少它对一些url的不必要的检查从而减省开销  
    compression=&quot;on&quot;      #开启压缩功能，HTTP 压缩可以大大提高浏览网站的速度      
    compressionMinSize=&quot;2048&quot;       #启用压缩的输出内容大小，这里面默认为2KB   
    compressableMimeType=&quot;text/html,text/xml,text/javascript,text/css,text/plain&quot;       #压缩类型   
    redirectPort=&quot;8443&quot;    #走https协议的话，我们将会用到8443端口
/&gt;      
</code></pre>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/06/07/scp和rsync/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="yangzhijun">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://raw.githubusercontent.com/yangzhij/images2/master/1.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yangzhijun">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/06/07/scp和rsync/" itemprop="url">scp和rsync</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-06-07T16:20:15+08:00">
                2019-06-07
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>scp和rsync都用于（本地或远程）文件拷贝传输<br>区别：<br>scp相当于复制粘贴，文件存在则覆盖。每一次都会同步所有文件。<br>rsync是复制。文件存在会直接跳过。第一次会同步所有文件，后面只同步修改过的文件。<br>//scp<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">语法：本地远程都需安装yum -y install openssh-clients</span><br><span class="line">scp 172.20.100.11:/home/www.txt /data   拷贝远程文件到本地/data目录下</span><br><span class="line">scp /data/a.txt 172.20.100.11:/home/     拷贝本地文件到远程/home目录下</span><br><span class="line">如果是传输目录的话，要加-r</span><br><span class="line">scp -r 172.20.100.11:/home/www  /data</span><br></pre></td></tr></table></figure></p>
<p>//rsync<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">rsync语法举例：本地远程都需安装 yum -y install rsync</span><br><span class="line">rsync -av --progress web-mobile/ web-mobile-yaoji/ --exclude &apos;customer_config.json&apos;</span><br><span class="line">---除customer_config.json文件外，同步web-mobile下所有东西到web-mobile-yaoji目录下</span><br><span class="line">-a：归档模式，以递归方式拷贝文件，同时保留文件属性</span><br><span class="line">-v:显示详细信息</span><br><span class="line">--progress：显示数据传输的进度信息</span><br><span class="line">--exclude：排除指定文件或目录</span><br><span class="line"></span><br><span class="line">[ ! -d /tmp/myrpms ] &amp;&amp; mkdir -p /tmp/myrpms           #目录不存在则创建</span><br><span class="line"></span><br><span class="line">rsync -avz root@192.168.0.100:/home/tarunika/rpmpkgs /tmp/myrpms     把远程主机100下的的文件拷贝到本地</span><br><span class="line">rsync -av a/ 172.20.100.155:/home/a/       把本地a目录下的东西同步到远程主机155上的/home/a目录下 </span><br><span class="line">rsync -av ./redis.tar.gz /home/wwtest         如果wwtest不是目录，这句话的意思就是把当前目录下的redis文件拷贝到home目录下，并命名为wwtest。 如果是目录，则会把redis放到该目录下，文件名不变。  </span><br><span class="line"></span><br><span class="line">可以创建密码文件rsync.pass，然后使用--password-file指定此文件，这样就不用每次都输密码了。</span><br><span class="line">echo &quot;123&quot; &gt; rsync.pass   #服务器端用户tom的密码</span><br><span class="line">rsync -avz --delete --password-file=rsync.pass tom@172.20.100.152::wwwroot /dest</span><br></pre></td></tr></table></figure></p>
<p>###exclude<br>du -sh /<em><br>du -sh /</em> –exclude=”proc”          排除目录proc</p>
<p>如果是多个后缀类型需要被排除可以在后面添加，无限制如下：<br>tar -cvf test.tgz test/ –exclude <em>.txt –exclude </em>.jpg</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/06/03/MYSQL压测-sysbench/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="yangzhijun">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://raw.githubusercontent.com/yangzhij/images2/master/1.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yangzhijun">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/06/03/MYSQL压测-sysbench/" itemprop="url">MYSQL压测 sysbench</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-06-03T16:02:22+08:00">
                2019-06-03
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>sysbench安装<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum -y install mysql57-community-release-el7-10.noarch.rpm</span><br><span class="line">yum install sysbench</span><br></pre></td></tr></table></figure></p>
<p>测试准备: 先创建一个库sbtest, 然后通过下面的语句来生成10张表 每个表填充100W条数据<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">sysbench /usr/share/sysbench/tests/include/oltp_legacy/oltp.lua --mysql-host=172.20.100.115 --mysql-port=3306 \</span><br><span class="line"> --mysql-user=root --mysql-password=123456 \</span><br><span class="line"> --oltp-num-tables=10 --oltp-table-size=1000000 --oltp-test-mode=complex  --report-interval=10 prepare</span><br><span class="line"></span><br><span class="line">//释义</span><br><span class="line">--oltp-num-tables=10   生成 10 张测试表</span><br><span class="line">--oltp-table-size=1000000	每张表填充数据为1000000</span><br><span class="line">--oltp-test-mode=complex	执行模式</span><br><span class="line">--report-interval=10   表示每10秒输出一次测试进度报告</span><br></pre></td></tr></table></figure></p>
<p>开始测试<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">sysbench /usr/share/sysbench/tests/include/oltp_legacy/oltp.lua --mysql-host=172.20.100.115 --mysql-port=3306 \</span><br><span class="line"> --mysql-user=root --mysql-password=123456 \</span><br><span class="line"> --oltp-num-tables=10 --oltp-table-size=1000000 --oltp-test-mode=complex \</span><br><span class="line"> --num-threads=128 --max-time=120 --report-interval=10 run</span><br><span class="line"></span><br><span class="line">//释义</span><br><span class="line">--max-time=120    压测持续时间，此为2分钟</span><br><span class="line">--num-threads=128 并发线程数，可以理解为模拟的客户端并发连接数（可以把num-threads依次递增（16,36,72,128,256,512））</span><br></pre></td></tr></table></figure></p>
<p>//mysql自带压测工具mysqlslap<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#80个客户端插入100W条数据需要多长时间？</span><br><span class="line">mysqlslap -uroot -p123456 -a --auto-generate-sql-write-number=1 -c 80 -i 1 --auto-generate-sql-load-type=write --number-of-queries=1000000</span><br></pre></td></tr></table></figure></p>
<p>//释义<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">-a 自动生成测试表和数据，表示用mysqlslap工具自己生成的SQL脚本来测试并发压力。</span><br><span class="line">--auto-generate-sql-write-number=1   用系统自己生成的SQL脚本来测试,初始化1行</span><br><span class="line">-c 80 表示并发量，也就是模拟80个客户端同时执行write</span><br><span class="line">-i 1 要运行这些测试多少次</span><br><span class="line">--auto-generate-sql-load-type=write   要测试的是读还是写还是两者混合的（read,write,update,mixed）</span><br><span class="line">--number-of-queries=100000        总共运行这么多次写入</span><br><span class="line"></span><br><span class="line">//上述命令输出内容</span><br><span class="line">mysqlslap: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">Benchmark</span><br><span class="line">        Average number of seconds to run all queries: 109.042 seconds   运行所有查询的平均秒数：109.042秒</span><br><span class="line">        Minimum number of seconds to run all queries: 109.042 seconds	运行所有查询的最小秒数：109.042秒</span><br><span class="line">        Maximum number of seconds to run all queries: 109.042 seconds	运行所有查询的最大秒数：109.042秒</span><br><span class="line">        Number of clients running queries: 80	运行查询的客户端数：80</span><br><span class="line">        Average number of queries per client: 12500		每个客户端的平均查询数：12500</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/05/31/Mysql-DBA基础/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="yangzhijun">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://raw.githubusercontent.com/yangzhij/images2/master/1.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yangzhijun">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/05/31/Mysql-DBA基础/" itemprop="url">Mysql-DBA基础</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-05-31T01:16:37+08:00">
                2019-05-31
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="数据库相关概念"><a href="#数据库相关概念" class="headerlink" title="//数据库相关概念"></a>//数据库相关概念</h3><p>DBMS：数据库管理系统，用于管理DB实例<br>DB：数据库，保存一组有组织的数据的容器<br>SQL: 结构化查询语言</p>
<h3 id="数据库存储数据特点"><a href="#数据库存储数据特点" class="headerlink" title="//数据库存储数据特点"></a>//数据库存储数据特点</h3><p>数据在表中，表在库中。一个数据库中可以有多个表，表名具有唯一性。表由列组成，也称列为字段。表中的数据是按行存储的。</p>
<h3 id="SQL常见命令"><a href="#SQL常见命令" class="headerlink" title="//SQL常见命令"></a>//SQL常见命令</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">show databases;		查看所有的数据库</span><br><span class="line">use 库名	打开指定的库</span><br><span class="line">show tables;	显示库中的所有表</span><br><span class="line">show tables from 库名;   显示指定库中的所有表</span><br><span class="line">desc 表名;    查看表结构</span><br><span class="line">select version();    查看mysql版本</span><br><span class="line">mysql --version 或 mysql --V</span><br></pre></td></tr></table></figure>
<h3 id="语法规范"><a href="#语法规范" class="headerlink" title="//语法规范"></a>//语法规范</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">不区分大小写，命令最好用分号结尾。</span><br><span class="line">注释：</span><br><span class="line">单行注释：#注释文字</span><br><span class="line">单行注释：-- 注释文字，--后面有一个空格</span><br><span class="line">多行注释：/* 注释文字 */</span><br></pre></td></tr></table></figure>
<h3 id="SQL语言分类"><a href="#SQL语言分类" class="headerlink" title="//SQL语言分类"></a>//SQL语言分类</h3><p>1.DML:数据操作语言<br>select（DQL 数据查询语言）、insert 、update、delete<br>2.DDL：数据定义语言，针对的是库和表<br>create、drop、alter<br>3.TCL：事务控制语言<br>commit、rollback<br>4.DCL：数据权限控制语言</p>
<h3 id="DQL语言"><a href="#DQL语言" class="headerlink" title="//DQL语言"></a>//DQL语言</h3><p>select查询完的结果，是一个虚拟的表格，不是真实存在。要查询的东西 可以是常量值、可以是表达式、可以是字段、可以是函数<br>1.基础查询<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">select 查询列表 from 表名;</span><br><span class="line">select distinct  列名 from 表名;   distinct去重</span><br><span class="line">select concat(‘参数1’,&apos;参数2&apos;,...) AS &apos;别名&apos; from 表名;    concat拼接，AS别名</span><br><span class="line">select ifnull(列名,0) AS 别名 from 表名;     infull判断字段是否为空，是的话则返回0，不是返回原本的值</span><br></pre></td></tr></table></figure></p>
<p>2.条件查询<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select 查询列表 from 表名 where 筛选条件;</span><br></pre></td></tr></table></figure></p>
<p>筛选条件分类：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line">按条件表达式</span><br><span class="line">	条件运算符：&gt; &lt; &gt;= &lt;= = != &lt;&gt;</span><br><span class="line">按逻辑表达式</span><br><span class="line">	逻辑运算符：and（&amp;&amp;）or(||) not(!)</span><br><span class="line">	逻辑运算符的作用： 用于连接条件表达式</span><br><span class="line">		select * from 表名 where not(条件1  and 条件2) or 条件3;</span><br><span class="line">模糊查询</span><br><span class="line">	like</span><br><span class="line">		like &apos;%a%&apos;   </span><br><span class="line">		like &apos;__n_w%&apos;  第三个字符为n,第五个字符为w</span><br><span class="line">		like &apos;_\_%&apos;;   第二个字符为_，其中\为转义;	like &apos;_$_%&apos; escape &apos;$&apos;;  转移符可以是任意的，后面用escape定义一下就好了</span><br><span class="line">范围查询</span><br><span class="line">	between and</span><br><span class="line">		如id在100到120之间   id &gt;= 100 and id &lt;=120 可以写成 id between 100 and 120;</span><br><span class="line">	in 判断某字段的值是否属于in列表的某一项</span><br><span class="line">		... where id in (15,16,17);</span><br><span class="line">空判断		</span><br><span class="line">	is null   为空</span><br><span class="line">	is not null 不为空</span><br><span class="line"></span><br><span class="line">3.排序查询 order by </span><br><span class="line">语法： SELECT * FROM 表名 ORDER BY 列1 ASC|DESC [,列2 ASC|DESC,...]</span><br><span class="line"></span><br><span class="line">ASC 默认升序</span><br><span class="line">DESC 降序</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">4.聚合查询</span><br><span class="line">COUNT(*)  总数</span><br><span class="line">MAX(列名) 最大值</span><br><span class="line">MIN(列名) 最小值</span><br><span class="line">SUM(列名) 求和</span><br><span class="line">AVG(列名) 平均值</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">5.分组  group by</span><br><span class="line"></span><br><span class="line">GROUP BY + GROUP_CONCAT() GROUP_CONCAT(字段名)可以作为一个输出字段来使用</span><br><span class="line">SELECT gender,GROUP_CONCAT(NAME) FROM students GROUP BY gender;</span><br><span class="line"></span><br><span class="line">GROUP BY + 聚合函数 </span><br><span class="line">SELECT gender,AVG(height) FROM students GROUP BY gender;</span><br><span class="line"></span><br><span class="line">GROUP BY + HAVING having表达式，用来分组以后设定条件筛选数据，功能和where一样，但是having只能用于group BY</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">6.子查询</span><br><span class="line">在一个select语句中，嵌入另外一个select语句，被嵌入的语句就是子查询语句</span><br><span class="line">主查询 主要查询的对象,第一条 SELECT 语句</span><br><span class="line"></span><br><span class="line">主查询和子查询的关系</span><br><span class="line"></span><br><span class="line">子查询是嵌入到主查询中</span><br><span class="line">子查询是辅助主查询的,要么充当条件,要么充当数据源</span><br><span class="line">子查询是可以独立存在的语句,是一条完整的 SELECT 语句</span><br><span class="line"></span><br><span class="line">7.分页</span><br><span class="line">当数据量很大的时候，就不可能在一页中查看所有数据了，需要对它进行分页操作</span><br><span class="line">语法: SELECT * FROM 表名 LIMIT START,COUNT</span><br><span class="line">举例：select * FROM WHERE gender=1 LIMIT 0,3; 查询前三条男生记录</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">8. mysql 权限</span><br><span class="line">超级用户root</span><br><span class="line">库级用户</span><br><span class="line">表级用户 </span><br><span class="line">字段(某些列)级别用户</span><br><span class="line">存储程序级别用户</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">9. 连接查询</span><br><span class="line"># 语法： select * from 表1 inner或left或right join 表2 on 表1.列 = 表2.列</span><br><span class="line">内连接</span><br><span class="line">左连接</span><br><span class="line">右连接</span><br><span class="line"></span><br><span class="line">#内连接 查询的结果为两个表匹配到的数据,并不是两张表所有的数据</span><br><span class="line"></span><br><span class="line">SELECT * FROM students INNER JOIN classes ON students.cls_id = classe.id;</span><br><span class="line"></span><br><span class="line">#使用左关联还是右关联  主要看侧重于哪张表</span><br><span class="line"></span><br><span class="line">SELECT * FROM students AS s LEFT JOIN classes AS c ON s.cls_id = c.id; </span><br><span class="line"></span><br><span class="line">SELECT * FROM students AS s RIGHT JOIN classes AS c ON s.cls_id = c.id; </span><br><span class="line"></span><br><span class="line">SELECT s.name,c.name FROM students s INNER JOIN classes c ON s.`cls_id` = c.`id`;</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/05/23/linux基本优化/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="yangzhijun">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://raw.githubusercontent.com/yangzhij/images2/master/1.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yangzhijun">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/05/23/linux基本优化/" itemprop="url">linux基本优化</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-05-23T09:55:48+08:00">
                2019-05-23
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>//内核优化(调整Linux网络内核对TCP连接的有关限制等)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/sysctl.conf</span><br><span class="line">net.ipv4.route.gc_timeout = 100</span><br><span class="line">net.core.rmem_default = 256960</span><br><span class="line">net.ipv4.ip_local_port_range = 1024 65000</span><br><span class="line">net.core.rmem_max = 513920</span><br><span class="line">net.core.wmem_default = 256960</span><br><span class="line">net.core.wmem_max = 513920</span><br><span class="line">net.ipv4.tcp_rmem = 8760  256960  4088000</span><br><span class="line">net.ipv4.tcp_rmem = 8760  256960  4088000</span><br><span class="line">net.ipv4.tcp_wmem = 8760  256960  4088000</span><br><span class="line">net.ipv4.tcp_fin_timeout = 30</span><br><span class="line">net.ipv4.tcp_tw_recycle = 1</span><br><span class="line">net.ipv4.tcp_timestamps = 1</span><br><span class="line">net.ipv4.tcp_window_scaling = 1</span><br><span class="line">net.ipv4.tcp_sack = 1</span><br><span class="line">net.ipv4.tcp_fack = 1</span><br><span class="line">net.ipv4.tcp_congestion_control = htcp</span><br><span class="line">net.ipv4.tcp_mtu_probing = 1</span><br><span class="line">net.core.optmem_max = 81920</span><br><span class="line">net.core.netdev_max_backlog = 2000</span><br><span class="line">net.ipv4.tcp_no_metrics_save = 1</span><br><span class="line">net.core.somaxconn = 262144</span><br><span class="line">net.ipv4.tcp_mem = 131072  262144  524288</span><br><span class="line">net.ipv4.tcp_syncookies = 1</span><br><span class="line">net.ipv4.tcp_tw_reuse = 1</span><br><span class="line">net.ipv4.tcp_max_orphans = 262144</span><br><span class="line">net.ipv4.tcp_max_syn_backlog = 2048</span><br><span class="line">net.ipv4.tcp_synack_retries = 1</span><br><span class="line">net.ipv4.tcp_syn_retries = 1</span><br><span class="line">kernel.shmmax = 134217728</span><br><span class="line">net.ipv4.tcp_keepalive_time = 1800</span><br><span class="line">net.ipv4.tcp_keepalive_intvl = 30</span><br><span class="line">net.ipv4.tcp_keepalive_probes = 3</span><br><span class="line">//参数及时生效命令</span><br><span class="line">sysctl -p</span><br></pre></td></tr></table></figure></p>
<p>//操作系统对一个进程打开的文件句柄数量的限制<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/security/limits.conf </span><br><span class="line">*                soft    nofile  65535</span><br><span class="line">*                hard    nofile  65535</span><br><span class="line">*                soft    nproc   65535</span><br><span class="line">*                hard    nproc   65535</span><br></pre></td></tr></table></figure></p>
<p>//文件末尾添加<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/sysctl.conf</span><br><span class="line">fs.file-max=65535   #保存退出</span><br><span class="line">sysctl -p  生效配置</span><br></pre></td></tr></table></figure></p>
<p>//设置linux用户的最大进程数以及每个进程可打开的文件数<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ulimit -n 65535</span><br><span class="line">ulimit -u 65535</span><br></pre></td></tr></table></figure></p>
<p>//历史数据条数优化<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/profile</span><br><span class="line"># add at 2019-05-13</span><br><span class="line">HISTFILESIZE=30000</span><br><span class="line">HISTSIZE=10000</span><br><span class="line">HISTTIMEFORMAT=&apos;%Y-%m-%dT%T &apos;</span><br><span class="line">export HISTTIMEFORMAT</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/05/20/mysql5-7-mycat-keepalived/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="yangzhijun">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://raw.githubusercontent.com/yangzhij/images2/master/1.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yangzhijun">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/05/20/mysql5-7-mycat-keepalived/" itemprop="url">mysql5.7+mycat+keepalived</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-05-20T09:46:36+08:00">
                2019-05-20
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>mysql主从<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">主库负责增删改操作。从库负责查询。</span><br><span class="line">	原理：</span><br><span class="line">		master将操作语句（数据的改变）记录到binlog日志中（在每个事务更新数据完成之前），然后授予slave远程连接的权限。（前提：master一定要开启binlog二进制日志功能）</span><br><span class="line">		slave开启两个线程：IO线程和SQL线程。IO线程负责读取master的binlog内容到中继日志relay log里；SQL线程负责从relay log日志里读出binlog内容，并更新到slave的数据库里。（这样来保证主从数据的一致）</span><br><span class="line">	要求：</span><br><span class="line">		主从版本一致</span><br><span class="line">		节点时间一致</span><br><span class="line">	优点：</span><br><span class="line">		降低主服务器压力;（主库写，从库读，降压）</span><br><span class="line">		在从库进行备份，避免备份期间影响主库服务;（确保数据安全）</span><br><span class="line">		主从切换（提升性能）</span><br><span class="line">	主从部署必要条件：</span><br><span class="line">		主库开启binlog日志（设置log-bin参数）</span><br><span class="line">		从库服务器能连通主库</span><br><span class="line">		主从server-id不同</span><br><span class="line">	</span><br><span class="line">	半同步复制---解决数据丢失的问题，通过安装插件</span><br><span class="line">	并行复制----解决从库复制延迟的问题，通过在my.cnf里配置参数</span><br><span class="line">		</span><br><span class="line">主从与主主模式:</span><br><span class="line">	主从复制：主库授权从库远程连接，通过读取主库binlog并更新到本地数据库的过程。从库跟着主库Centos7下mysql5.7+mycat+keepalived变。</span><br><span class="line">	主主复制：主从相互授权连接，读取对方binlog日志并更新到本地数据库的过程。双方都随着对方的改变而改变。</span><br><span class="line"></span><br><span class="line">当从库的IO和SQL线程的状态均为Yes，则表示主从已实现同步了！</span><br></pre></td></tr></table></figure></p>
<p>//部署如下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/src/</span><br><span class="line">#官网下载mysql-server</span><br><span class="line">wget http://dev.mysql.com/get/mysql57-community-release-el7-10.noarch.rpm</span><br><span class="line">#mysql依赖包</span><br><span class="line">yum -y install mysql57-community-release-el7-10.noarch.rpm</span><br><span class="line">#安装mysql数据库</span><br><span class="line">yum -y install mysql-community-server</span><br><span class="line">#安装sysbench基准测试工具，依赖于上述mysql依赖包</span><br><span class="line">yum install sysbench</span><br><span class="line">#启动</span><br><span class="line">systemctl start mysqld</span><br><span class="line"># 设置开机启动</span><br><span class="line">systemctl enable mysqld</span><br><span class="line">systemctl daemon-reload</span><br><span class="line">#在日志文件中查看初始密码</span><br><span class="line">grep &quot;password&quot; /var/log/mysqld.log</span><br><span class="line">#进入修改密码，必须先修改，否则啥也不能做，可能会提示密码过于简单之类的报错，先设置个复杂的，然后再修改密码规则</span><br><span class="line">mysql -uroot -p</span><br><span class="line">mysql&gt; ALTER USER &apos;root&apos;@&apos;localhost&apos; IDENTIFIED BY &apos;P@ssw0rd123&apos;;</span><br><span class="line"></span><br><span class="line">#查看mysql密码规则</span><br><span class="line">mysql&gt; SHOW VARIABLES LIKE &apos;validate_password%&apos;;</span><br><span class="line">#修改MySQL默认策略和密码长度（mysql5.7默认安装了密码安全检查插件（validate_password），默认密码检查策略要求密码必须包含：大小写字母、数字和特殊符号，并且长度不能少于8位。）</span><br><span class="line">mysql&gt; set global validate_password_policy=0;</span><br><span class="line">mysql&gt; set global validate_password_policy=LOW;</span><br><span class="line">mysql&gt; SET GLOBAL validate_password_length=6;</span><br><span class="line"></span><br><span class="line">#之后就可以改成简单密码了</span><br><span class="line">mysql&gt; ALTER USER &apos;root&apos;@&apos;localhost&apos; IDENTIFIED BY &apos;123456&apos;;</span><br><span class="line"></span><br><span class="line">#卸载安装源自动更新</span><br><span class="line">yum -y remove mysql57-community-release.noarch</span><br><span class="line"></span><br><span class="line">#初始化数据库</span><br><span class="line">[root@localhost ~]# mysql_secure_installation</span><br><span class="line">Enter password for user root:    #需输入mysql密码</span><br><span class="line">一路回车</span><br><span class="line">Disallow root login remotely?    看情况是否允许root用户远程访问</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">6.进入数据库设置远程登录用户，不一定要是root</span><br><span class="line">mysql&gt; grant all privileges on *.* to &apos;root&apos;@&apos;%&apos; identified by &apos;123456&apos; with grant option;</span><br><span class="line">mysql&gt; flush privileges;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">配置主mysql数据库配置文件：vim /etc/my.cnf</span><br><span class="line">    1、配置文件配置完之后，登录mysql数据库设置数据同步权限</span><br><span class="line">        mysql&gt; grant replication slave,replication client on *.* to root@&apos;172.20.100.122&apos; identified by &quot;wwwmysqlpw;</span><br><span class="line">        mysql&gt;flush privileges;</span><br><span class="line">		</span><br><span class="line">    2、查看master服务器状态</span><br><span class="line">        mysql&gt; show master status;(注意File与Position项，从服务器需要这两项参数)	</span><br><span class="line"></span><br><span class="line">配置从mysql配置文件:vim /etc/my.cnf，只需要变更一下配置中的server-id,</span><br><span class="line">#添加一下</span><br><span class="line">slave-skip-errors = all #跳过所有的错误错误，继续执行复制操作</span><br><span class="line">	配置主从同步指令</span><br><span class="line">mysql&gt;stop slave;   ＃执行同步前，要先关闭slave</span><br><span class="line">mysql&gt;change  master to master_host=&apos;172.20.100.121&apos;,master_user=&apos;root&apos;,master_password=&apos;wwwmysqlpw&apos;,master_log_file=&apos;mysql-bin.000006&apos;,master_log_pos=110;	</span><br><span class="line">mysql&gt;start slave;          #开启同步</span><br><span class="line">mysql&gt;show slave status \G</span><br><span class="line"></span><br><span class="line">当IO和SQL线程的状态均为Yes，则表示主从已实现同步了！</span><br><span class="line"></span><br><span class="line">主从同步是基于主从配置完之后开始，并且mysql主从部署之后可能会出现主从同步延迟的问题</span><br></pre></td></tr></table></figure></p>
<p>—mycat安装<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/src/</span><br><span class="line">wget http://dl.mycat.io/1.6-RELEASE/Mycat-server-1.6-RELEASE-20161028204710-linux.tar.gz</span><br><span class="line">tar -zxvf Mycat-server-1.6-RELEASE-20161028204710-linux.tar.gz</span><br><span class="line">chmod -R 777 mycat</span><br><span class="line">添加环境变量</span><br><span class="line">vi /etc/profile</span><br><span class="line">export MYCAT_HOME=/usr/local/src/mycat</span><br><span class="line">export PATH=$PATH:$MYCAT_HOME/bin</span><br><span class="line">使环境变量生效</span><br><span class="line">source /etc/profile</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mycat配置文件</span><br><span class="line">cd /usr/local/src/mycat/conf</span><br><span class="line">schema.xml       数据库设置，分库分表规则</span><br><span class="line">server.xml	    用户权限设置，与mysql无关</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">启动mycat</span><br><span class="line">cd /usr/local/src/mycat/bin/</span><br><span class="line">sh mycat start</span><br></pre></td></tr></table></figure></p>
<p>用户授权<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; grant select,update,delete,insert on micro_game.* to test@&apos;%&apos; identified by &apos;test@123456&apos;;</span><br><span class="line">mysql&gt; flush privileges;</span><br></pre></td></tr></table></figure></p>
<p>mysql半同步复制配置<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">主库配置</span><br><span class="line">mysql&gt; INSTALL PLUGIN rpl_semi_sync_master SONAME &apos;semisync_master.so&apos;;</span><br><span class="line">mysql&gt; set global rpl_semi_sync_master_enabled=on;</span><br><span class="line"></span><br><span class="line">从库配置</span><br><span class="line">mysql&gt;  INSTALL PLUGIN rpl_semi_sync_slave SONAME &apos;semisync_slave.so&apos;;</span><br><span class="line">mysql&gt;  set global rpl_semi_sync_slave_enabled=on;</span><br><span class="line"></span><br><span class="line">加入my.cnf参数</span><br><span class="line">主库[mysqld]添加：</span><br><span class="line">rpl_semi_sync_master_enabled = 1</span><br><span class="line">从库[mysqld]添加：</span><br><span class="line">rpl_semi_sync_slave_enabled = 1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">在主从上验证一下</span><br><span class="line">mysql&gt; show global status like &apos;rpl_semi%&apos;;</span><br><span class="line">Rpl_semi_sync_master_status                | ON    |</span><br><span class="line">Rpl_semi_sync_slave_status | ON    |</span><br></pre></td></tr></table></figure></p>
<p>程序配置文件：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">database=micro_game</span><br><span class="line">server=172.20.100.247:8066   --注意提供的是mycat的端口,因为只有通过mycat才能实现读写分离，帮你转发</span><br><span class="line">username=test</span><br><span class="line">password=test@123456</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/05/15/mysql-PXC集群/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="yangzhijun">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://raw.githubusercontent.com/yangzhij/images2/master/1.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yangzhijun">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/05/15/mysql-PXC集群/" itemprop="url">mysql_PXC集群</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-05-15T11:09:42+08:00">
                2019-05-15
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>mysql PXC集群<br>—–至少3个节点，便于故障恢复<br>—–同步复制，集群中每个节点都包含完整数据<br>—–可以从集群中分离某节点单独使用。对于集群中新节点的加入，维护起来很简单。<br>—–PXC可以实现多个节点间的数据同步复制以及读写，并且保证了数据库的服务高可用及数据强一致性。<br>—–写性能依赖最慢的那个机器，因为PXC集群采用的是强一致性原则，一个更改操作在所有节点都成功才算执行成功。</p>
<p>//部署如下<br>从第1步到第11步，每个节点都要做<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">先修改3台机器的hostname</span><br><span class="line">[root@localhost ~]# hostname set-hostname pxc_node1</span><br><span class="line">修改hosts文件，三台机器都修改如下所示： </span><br><span class="line">172.20.100.185 pxc_node1</span><br><span class="line">172.20.100.186 pxc_node2</span><br><span class="line">172.20.100.187 pxc_node3</span><br><span class="line"></span><br><span class="line">1.vi /etc/selinux/config</span><br><span class="line">SELINUX=disabled   #修改该项为disabled</span><br><span class="line"></span><br><span class="line">2.setenforce 0</span><br><span class="line"></span><br><span class="line">3.systemctl status firewalld         //查看防火墙状态</span><br><span class="line">如果是开启的，则开放端口3306 、4444、4567、4568</span><br><span class="line">firewall-cmd --add-port=3306/tcp --permanent     #开放了3306端口</span><br><span class="line">重新加载防火墙规则</span><br><span class="line">firewall-cmd --reload</span><br><span class="line"></span><br><span class="line">4.安装Persona仓库</span><br><span class="line">yum -y install http://www.percona.com/downloads/percona-release/redhat/0.1-6/percona-release-0.1-6.noarch.rpm</span><br><span class="line"></span><br><span class="line">yum -y update percona-release</span><br><span class="line"></span><br><span class="line">5.安装PXC（保证服务器没有装MySQL） </span><br><span class="line">yum -y install Percona-XtraDB-Cluster-57</span><br><span class="line"></span><br><span class="line">6.开启PXC服务</span><br><span class="line">systemctl start mysql</span><br><span class="line"></span><br><span class="line">7.查看安装数据库的临时密码并记住</span><br><span class="line">grep &apos;temporary password&apos; /var/log/mysqld.log</span><br><span class="line"></span><br><span class="line">8.登录MySQL数据库</span><br><span class="line">mysql -u root -p</span><br><span class="line"></span><br><span class="line">9.登录成功后修改密码</span><br><span class="line">mysql&gt; ALTER USER &apos;root&apos;@&apos;localhost&apos; IDENTIFIED BY &apos;你的密码&apos;;</span><br><span class="line">mysql&gt; flush privileges; </span><br><span class="line">10.停止MySQL服务</span><br><span class="line">systemctl stop mysql   （某些版本使用mysqld）</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">11.开始配置节点</span><br><span class="line">--修改配置文件</span><br><span class="line">vi  /etc/percona-xtradb-cluster.conf.d/wsrep.cnf</span><br><span class="line">#集群中节点的IP地址（本机填最后）</span><br><span class="line">wsrep_cluster_address=gcomm://ip地址,IP地址,IP地址（用,号隔开）</span><br><span class="line"></span><br><span class="line">binlog_format=ROW</span><br><span class="line"></span><br><span class="line">default_storage_engine=InnoDB</span><br><span class="line"></span><br><span class="line">wsrep_slave_threads= 8</span><br><span class="line"></span><br><span class="line">wsrep_log_conflicts</span><br><span class="line"></span><br><span class="line">innodb_autoinc_lock_mode=2</span><br><span class="line"></span><br><span class="line">wsrep_node_address=当前节点IP地址</span><br><span class="line"></span><br><span class="line">#集群名称</span><br><span class="line">wsrep_cluster_name=pxc-cluster         </span><br><span class="line"></span><br><span class="line">#当前节点名称</span><br><span class="line">wsrep_node_name=pxc-cluster-node-1</span><br><span class="line"></span><br><span class="line">#不使用实验功能</span><br><span class="line">pxc_strict_mode=ENFORCING</span><br><span class="line"></span><br><span class="line">#状态快照传输（sst）方法，官方建议</span><br><span class="line">wsrep_sst_method=xtrabackup-v2</span><br><span class="line"></span><br><span class="line">#用户凭证（mysql的用户名和密码）</span><br><span class="line">wsrep_sst_auth=&quot;用户名:密码&quot;</span><br><span class="line"></span><br><span class="line">剩下的节点修改当前节点名、当前节点IP、集群中的节点IP，其他相同</span><br></pre></td></tr></table></figure></p>
<p>———————————————————————以上所有步骤   每个节点都要配置一次<br>//下面开始初始化集群节点<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">12.其中一个节点使用 systemctl start mysql@bootstrap.service 启动</span><br><span class="line">登录mysql  </span><br><span class="line"></span><br><span class="line">   mysql -u root -p</span><br><span class="line"></span><br><span class="line">开启 wsrep_causal_reads</span><br><span class="line"></span><br><span class="line">mysql&gt; set wsrep_causal_reads =1;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">13.创建配置文件中对应的用户   所有节点的IP都要创建</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">创建用户：   CREATE USER &apos;用户名&apos;@&apos;localhost&apos; IDENTIFIED BY &apos;密码&apos;;  </span><br><span class="line">刷新权限：   GRANT all privileges ON *.* TO &apos;用户名&apos;@&apos;localhost&apos; ;</span><br><span class="line">                      FLUSH PRIVILEGES;</span><br><span class="line"></span><br><span class="line">创建用户：   CREATE USER &apos;用户名&apos;@&apos;当前需要访问数据库的IP地址&apos; IDENTIFIED BY &apos;密码&apos;;  </span><br><span class="line">刷新权限：   GRANT all privileges ON *.* TO &apos;用户名&apos;@&apos;当前需要访问数据库的IP地址&apos; ;</span><br><span class="line">                      FLUSH PRIVILEGES;</span><br><span class="line"></span><br><span class="line">14.其他节点使用   systemctl start mysql  启动 ，登录mysql，配置wsrep_causal_reds，set wsrep_causal_reads =1;</span><br><span class="line"></span><br><span class="line">15.其他节点启动成功后在引导节点（使用 systemctl start mysql@bootstrap.service 命令启动的节点）</span><br><span class="line"></span><br><span class="line">验证集群：show status like &apos;wsrep%&apos;;  </span><br><span class="line"></span><br><span class="line">------------到这里真的就搭建完了   可以试着在其中一台节点创建个数据库，这样别的节点就都有了</span><br><span class="line"></span><br><span class="line">注意：服务的启动和停止要对应</span><br><span class="line"></span><br><span class="line">        systemctl stop mysql   ------&gt;  启动时用systemctl start mysql</span><br><span class="line">或者 </span><br><span class="line">        systemctl stop mysql@bootstrap.service   -----&gt;  启用是用 systemctl start mysql@bootstrap.service</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/03/12/zabbix监控rabbitmq/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="yangzhijun">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://raw.githubusercontent.com/yangzhij/images2/master/1.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yangzhijun">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/03/12/zabbix监控rabbitmq/" itemprop="url">zabbix监控rabbitmq</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-03-12T20:13:24+08:00">
                2019-03-12
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          The article has been encrypted, please enter your password to view.<br>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2019/03/12/zabbix监控rabbitmq/#more" rel="contents">
              Read more &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/03/04/随笔/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="yangzhijun">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://raw.githubusercontent.com/yangzhij/images2/master/1.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yangzhijun">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/03/04/随笔/" itemprop="url">随笔</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-03-04T04:18:58+08:00">
                2019-03-04
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          The article has been encrypted, please enter your password to view.<br>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2019/03/04/随笔/#more" rel="contents">
              Read more &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/02/18/zabbix配置邮件报警/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="yangzhijun">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://raw.githubusercontent.com/yangzhij/images2/master/1.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yangzhijun">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/02/18/zabbix配置邮件报警/" itemprop="url">zabbix配置邮件报警</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-02-18T17:47:41+08:00">
                2019-02-18
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>//zabbix服务端安装<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">yum -y install sendmail</span><br><span class="line">yum install mailx –y</span><br><span class="line">systemctl start mail</span><br><span class="line">systemctl start sendmail.service</span><br></pre></td></tr></table></figure></p>
<p>//测试<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo &quot;zabbix testmail&quot; |mail -s &quot;zabbix&quot; zhangsan@163.com</span><br></pre></td></tr></table></figure></p>
<p>//测试正常后，开始配置zabbix界面<br><img src="https://raw.githubusercontent.com/yangzhij/images2/master/zbx-mail1.png" alt="https://raw.githubusercontent.com/yangzhij/images2/master/zbx-mail1.png"><br><img src="https://raw.githubusercontent.com/yangzhij/images2/master/zbx-mail2.png" alt="https://raw.githubusercontent.com/yangzhij/images2/master/zbx-mail2.png"><br><img src="https://raw.githubusercontent.com/yangzhij/images2/master/zbx-mail3.png" alt="https://raw.githubusercontent.com/yangzhij/images2/master/zbx-mail3.png"><br><img src="https://raw.githubusercontent.com/yangzhij/images2/master/zbx-mail4.png" alt="https://raw.githubusercontent.com/yangzhij/images2/master/zbx-mail4.png"><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">故障通知：服务器:&#123;HOSTNAME1&#125; &#123;EVENT.NAME&#125;！！！</span><br><span class="line"></span><br><span class="line">告警主机:  &#123;HOSTNAME1&#125;&lt;br&gt;</span><br><span class="line">告警时间:  &#123;EVENT.DATE&#125;  &#123;EVENT.TIME&#125; &lt;br&gt;</span><br><span class="line">告警信息:  &#123;EVENT.NAME&#125;&lt;br&gt;</span><br><span class="line">告警项目:  &#123;TRIGGER.KEY1&#125;&lt;br&gt;</span><br><span class="line">事件ID:  &#123;EVENT.ID&#125;</span><br><span class="line">-------------------------------------------------------------------------------</span><br><span class="line">故障&#123;EVENT.NAME&#125;已恢复正常</span><br><span class="line"></span><br><span class="line">故障主机：&#123;HOST.NAME&#125;&lt;br&gt;</span><br><span class="line">恢复时间：&#123;EVENT.RECOVERY.DATE&#125; &#123;EVENT.RECOVERY.TIME&#125; &lt;br&gt;</span><br><span class="line">当前状态：&#123;EVENT.STATUS&#125;</span><br><span class="line">事件ID:  &#123;EVENT.ID&#125;</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/02/16/playbook安装rabbitmq/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="yangzhijun">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://raw.githubusercontent.com/yangzhij/images2/master/1.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yangzhijun">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/02/16/playbook安装rabbitmq/" itemprop="url">playbook安装rabbitmq</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-02-16T23:47:50+08:00">
                2019-02-16
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>//须知<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1.前提：ansible已安装，hosts文件已配置</span><br><span class="line">2.编写rabbitmq.yaml</span><br><span class="line">3.ansible-playbook --syntax-check rabbitmq.yaml    进行剧本配置信息语法检查</span><br><span class="line">3.执行ansible-playbook rabbitmq.yaml</span><br><span class="line">4.访问172.20.100.126:15672</span><br></pre></td></tr></table></figure></p>
<p>rabbitmq.yaml内容如下，注意不要有中文<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">- hosts: 172.20.100.126        //这里可以是单台主机，可以是多台，也可以是主机组，用:分隔。 all代表所有主机</span><br><span class="line">  remote_user: root</span><br><span class="line">  </span><br><span class="line">  tasks:</span><br><span class="line">        - name: installed need package         //name是对此任务进行解释，可以不写冒号后面的东西</span><br><span class="line">          yum: name=&#123;&#123; item &#125;&#125; state=present</span><br><span class="line">          with_items:</span><br><span class="line">                - gcc</span><br><span class="line">                - glibc-devel</span><br><span class="line">                - make</span><br><span class="line">                - ncurses-devel</span><br><span class="line">                - openssl-devel</span><br><span class="line">                - xmlto</span><br><span class="line">                - perl</span><br><span class="line">                - ntpdate</span><br><span class="line"></span><br><span class="line">        - name: set timezone to Asia/Shanghai</span><br><span class="line">          timezone:</span><br><span class="line">            name: Asia/Shanghai</span><br><span class="line"></span><br><span class="line">        - name: update time</span><br><span class="line">          shell: /usr/sbin/ntpdate cn.pool.ntp.org</span><br><span class="line">        </span><br><span class="line">        - name: write to system  </span><br><span class="line">          shell: hwclock --systohc</span><br><span class="line"></span><br><span class="line">        - selinux: state=disabled</span><br><span class="line"></span><br><span class="line">        - name: stop firewalld server </span><br><span class="line">          service: name=firewalld state=stopped enabled=false</span><br><span class="line">        </span><br><span class="line"></span><br><span class="line">        - name: install rabbitmq erlang package</span><br><span class="line">          yum: name=https://packagecloud.io/rabbitmq/erlang/packages/el/7/erlang-20.3-1.el7.centos.x86_64.rpm/download.rpm state=present</span><br><span class="line"></span><br><span class="line">        - name: install rabbitmq key file</span><br><span class="line">          shell: rpm --import https://www.rabbitmq.com/rabbitmq-release-signing-key.asc</span><br><span class="line"></span><br><span class="line">        - name: install socat</span><br><span class="line">          yum: name=socat state=latest</span><br><span class="line"></span><br><span class="line">        - name: install rabbitmq server</span><br><span class="line">          yum: name=https://github.com/rabbitmq/rabbitmq-server/releases/download/v3.7.8/rabbitmq-server-3.7.8-1.el7.noarch.rpm state=present</span><br><span class="line"></span><br><span class="line">        - name: start rabbitmq server</span><br><span class="line">          service: name=rabbitmq-server state=started enabled=true</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        - name: enable plugins</span><br><span class="line">          shell: rabbitmq-plugins enable rabbitmq_management</span><br><span class="line"></span><br><span class="line">        - name: restart servier</span><br><span class="line">          service: name=rabbitmq-server state=restarted</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        - name: enable account</span><br><span class="line">          shell: rabbitmqctl add_user admin admin123</span><br><span class="line">          </span><br><span class="line">        - name: grant account</span><br><span class="line">          shell: rabbitmqctl set_permissions -p / admin &quot;.*&quot; &quot;.*&quot; &quot;.*&quot;</span><br><span class="line">          </span><br><span class="line">        - name: setting account</span><br><span class="line">          shell: rabbitmqctl set_user_tags admin administrator</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/02/15/linux免秘钥登录/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="yangzhijun">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://raw.githubusercontent.com/yangzhij/images2/master/1.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yangzhijun">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/02/15/linux免秘钥登录/" itemprop="url">linux免秘钥登录</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-02-15T13:46:28+08:00">
                2019-02-15
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>//单台免秘钥登录<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen    //生成密钥</span><br><span class="line">ssh-copy-id   root@10.0.0.1      //推到远程主机，此过程需要输入密码</span><br><span class="line">ssh 10.0.0.1   //测试</span><br></pre></td></tr></table></figure></p>
<p>//比如3台主机相互免密码登录，就需要在3台上面都执行以上命令，新的秘钥会追加到相应文件，不会影响原来的。即：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1.在3台上都生成秘钥  ssh-keygen</span><br><span class="line">2.推送到其他两台 ssh-copy-id   root@10.0.0.2</span><br><span class="line">3.测试</span><br></pre></td></tr></table></figure></p>
<p>//比如几十台都通过免秘钥登陆呢？这时候就需要ansible了。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">vim  /etc/ansible/hosts </span><br><span class="line">[jenkins]·</span><br><span class="line">172.20.100.126</span><br><span class="line">172.20.100.217</span><br><span class="line">[jjaaa]</span><br><span class="line">172.20.100.218</span><br><span class="line">172.20.100.219</span><br><span class="line">执行下列语句(all是所有的，也可指定单个组，如下jjaaa)，如果ip的密码都是一样的，执行的时候需输入一次密码</span><br><span class="line">ansible all -m authorized_key -a &quot;user=root key=&apos;&#123;&#123; lookup(&apos;file&apos;, &apos;/root/.ssh/id_rsa.pub&apos;)&#125;&#125;&apos; path=&apos;/root/.ssh/authorized_keys&apos; manage_dir=no&quot; --ask-pass -c paramiko</span><br><span class="line">ansible jjaaa -m authorized_key -a &quot;user=root key=&apos;&#123;&#123; lookup(&apos;file&apos;, &apos;/root/.ssh/id_rsa.pub&apos;)&#125;&#125;&apos; path=&apos;/root/.ssh/authorized_keys&apos; manage_dir=no&quot; --ask-pass -c paramiko</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[jenkins]</span><br><span class="line">172.20.100.126 ansible_ssh_pass=&quot;old123456&quot;</span><br><span class="line">172.20.100.217 ansible_ssh_pass=&quot;123456</span><br><span class="line">如果密码不同  需要自定义</span><br><span class="line">ansible all -m authorized_key -a &quot;user=root key=&apos;&#123;&#123; lookup(&apos;file&apos;, &apos;/root/.ssh/id_rsa.pub&apos;)&#125;&#125;&apos; path=&apos;/root/.ssh/authorized_keys&apos; manage_dir=no&quot; --ask-pass -c paramiko</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[jenkins]</span><br><span class="line">172.20.100.126</span><br><span class="line">172.20.100.217</span><br><span class="line">172.20.100.157 ansible_ssh_pass=&quot;ley123456&quot;</span><br><span class="line">如果密码不同  需要自定义，</span><br><span class="line"></span><br><span class="line">看到这样的，&quot;Are you sure you want to continue connecting (yes/no)?&quot;。。。。直接回车就可以了</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/02/13/挂载磁盘/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="yangzhijun">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://raw.githubusercontent.com/yangzhij/images2/master/1.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yangzhijun">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/02/13/挂载磁盘/" itemprop="url">挂载磁盘</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-02-13T18:26:42+08:00">
                2019-02-13
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="挂载硬盘："><a href="#挂载硬盘：" class="headerlink" title="挂载硬盘："></a>挂载硬盘：</h3><ul>
<li>挂载哪块磁盘呢？</li>
<li>挂载到哪呢?</li>
</ul>
<h4 id="步骤如下"><a href="#步骤如下" class="headerlink" title="步骤如下"></a>步骤如下</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">1.查看磁盘分区信息</span><br><span class="line">fdisk -l</span><br><span class="line"></span><br><span class="line">2.输入fdisk /dev/sdb给硬盘进行分区，输入n回车新建分区，接着再输入p回车新建主分区</span><br><span class="line">fdisk /dev/sdb</span><br><span class="line">w  帮助命令</span><br><span class="line">n   新增</span><br><span class="line">p  主分区</span><br><span class="line">一路回车</span><br><span class="line">w  写入磁盘并退出</span><br><span class="line"></span><br><span class="line">对硬盘进行格式化：</span><br><span class="line">mkfs.xfs /dev/sdb1            </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">让后加的分区能够启动时自动挂载,需要把配置写入文件 /etc/fstab， 如下，挂载到home目录下</span><br><span class="line">vi /etc/fstab </span><br><span class="line">/dev/sdb1 /home                   xfs     defaults        0 0</span><br><span class="line"></span><br><span class="line">前3段： 分区名    挂载点   文件系统名称   </span><br><span class="line"></span><br><span class="line">加载文件/etc/fstab中描述的所有文件系统</span><br><span class="line">mount -a     </span><br><span class="line"></span><br><span class="line">然后df -lh 查看就有了</span><br></pre></td></tr></table></figure>
<p><img src="https://raw.githubusercontent.com/yangzhij/myself-images/master/cipan1.png" alt="https://raw.githubusercontent.com/yangzhij/myself-images/master/cipan1.png"><br><img src="https://raw.githubusercontent.com/yangzhij/myself-images/master/cipan2.png" alt="https://raw.githubusercontent.com/yangzhij/myself-images/master/cipan2.png"><br><img src="https://raw.githubusercontent.com/yangzhij/myself-images/master/cipan3.png" alt="https://raw.githubusercontent.com/yangzhij/myself-images/master/cipan3.png"></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/02/13/zabbix监控nginx/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="yangzhijun">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://raw.githubusercontent.com/yangzhij/images2/master/1.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yangzhijun">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/02/13/zabbix监控nginx/" itemprop="url">zabbix监控nginx</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-02-13T15:23:16+08:00">
                2019-02-13
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          The article has been encrypted, please enter your password to view.<br>
          <!--noindex-->
          <div class="post-button text-center">
            <a class="btn" href="/2019/02/13/zabbix监控nginx/#more" rel="contents">
              Read more &raquo;
            </a>
          </div>
          <!--/noindex-->
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/02/12/Grafana5安装配置及流量监控/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="yangzhijun">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://raw.githubusercontent.com/yangzhij/images2/master/1.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yangzhijun">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/02/12/Grafana5安装配置及流量监控/" itemprop="url">centos7下 Grafana5安装配置</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-02-12T10:22:20+08:00">
                2019-02-12
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong>本文档前提条件：Zabbix监控服务器、客户端都已经部署完成，被监控主机已添加完成，Zabbix监控运行正常</strong><br>//安装Grafana 5<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">方式1：官方源直接安装</span><br><span class="line">yum -y install https://dl.grafana.com/oss/release/grafana-5.4.2-1.x86_64.rpm</span><br><span class="line">方式2：使用安装包</span><br><span class="line">yum -y install initscripts fontconfig</span><br><span class="line">wget https://dl.grafana.com/oss/release/grafana-5.4.2-1.x86_64.rpm</span><br><span class="line">rpm -Uvh grafana-5.4.2-1.x86_64.rpm</span><br></pre></td></tr></table></figure></p>
<p>//安装服务端图像呈现组件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install fontconfig freetype* urw-fonts -y</span><br></pre></td></tr></table></figure></p>
<p>//启动grafana,并设置开机启动<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl start grafana-server            #启动服务</span><br><span class="line">systemctl enable grafana-server.service          #设置开机自启</span><br><span class="line">systemctl status grafana-server            #查看服务是否正常启动</span><br></pre></td></tr></table></figure></p>
<p>//开启防火墙放行3000端口<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">firewall-cmd --add-port=3000/tcp --permanent</span><br><span class="line">firewall-cmd --reload</span><br></pre></td></tr></table></figure></p>
<p>//访问，默认用户名密码：admin/admin，第一次登陆会要求改密码<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://172.20.100.219:3000</span><br></pre></td></tr></table></figure></p>
<p>//插件安装<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">安装grafana-zabbix插件</span><br><span class="line">grafana-cli plugins install alexanderzobnin-zabbix-app</span><br><span class="line"></span><br><span class="line">安装grafana-clock-panel插件：</span><br><span class="line">grafana-cli plugins install grafana-clock-panel</span><br><span class="line"></span><br><span class="line">安装grafana饼图插件</span><br><span class="line">grafana-cli plugins install grafana-piechart-panel</span><br></pre></td></tr></table></figure></p>
<p>//重启grafana服务<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart grafana-server</span><br></pre></td></tr></table></figure></p>
<p>点击进去拉到最后，点击zabbix，点击enable，然后最左侧就可以看到zabbix的图标了。<br><img src="https://raw.githubusercontent.com/yangzhij/myself-images/master/gr1.png" alt="https://raw.githubusercontent.com/yangzhij/myself-images/master/gr1.png"><br>下一步开始配置数据源<br><img src="https://raw.githubusercontent.com/yangzhij/myself-images/master/gr2.png" alt="https://raw.githubusercontent.com/yangzhij/myself-images/master/gr2.png"><br>Zabbix的URL地址为<a href="http://172.20.100.219/zabbix/api_jsonrpc.php" target="_blank" rel="noopener">http://172.20.100.219/zabbix/api_jsonrpc.php</a><br><img src="https://raw.githubusercontent.com/yangzhij/myself-images/master/gr3.png" alt="https://raw.githubusercontent.com/yangzhij/myself-images/master/gr3.png"><br><img src="https://raw.githubusercontent.com/yangzhij/myself-images/master/gr4.png" alt="https://raw.githubusercontent.com/yangzhij/myself-images/master/gr4.png"><br><img src="https://raw.githubusercontent.com/yangzhij/myself-images/master/gr5.png" alt="https://raw.githubusercontent.com/yangzhij/myself-images/master/gr5.png"><br>点进去选择<br><img src="https://raw.githubusercontent.com/yangzhij/myself-images/master/gr6.png" alt="https://raw.githubusercontent.com/yangzhij/myself-images/master/gr6.png"></p>
<p><strong>自定义监控网卡流量</strong><br>//最终效果图：<br><img src="https://raw.githubusercontent.com/yangzhij/myself-images/master/gra-eth0-1.png" alt="https://raw.githubusercontent.com/yangzhij/myself-images/master/gra-eth0-1.png"><br>//操作如下：<br>Dashboards-&gt;home-&gt;New dashboards-&gt;Graph<br><img src="https://raw.githubusercontent.com/yangzhij/myself-images/master/gra-eth0-2.png" alt="https://raw.githubusercontent.com/yangzhij/myself-images/master/gra-eth0-2.png"><br><img src="https://raw.githubusercontent.com/yangzhij/myself-images/master/gra-eth0-3.png" alt="https://raw.githubusercontent.com/yangzhij/myself-images/master/gra-eth0-3.png"><br><img src="https://raw.githubusercontent.com/yangzhij/myself-images/master/gra-eth0-4.png" alt="https://raw.githubusercontent.com/yangzhij/myself-images/master/gra-eth0-4.png"></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/02/11/zabbix监控服务端口/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="yangzhijun">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://raw.githubusercontent.com/yangzhij/images2/master/1.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yangzhijun">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/02/11/zabbix监控服务端口/" itemprop="url">zabbix监控服务端口</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-02-11T16:00:58+08:00">
                2019-02-11
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>1.被监控端上编写脚本，注意两个脚本属主为zabbix:zabbix<br>port_check.sh为端口自发现脚本,编写完后添加执行权限chmod +x port_check.sh<br>port.conf为指定的监控端口号</p>
<p>具体操作<br>编辑port_check.sh<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">mkdir /etc/zabbix/script/</span><br><span class="line">cd /etc/zabbix/script/</span><br><span class="line">more port_check.sh</span><br><span class="line">#/bin/bash</span><br><span class="line">CONFIG_FILE=/etc/zabbix/script/port.conf</span><br><span class="line">Check()&#123;</span><br><span class="line">    grep -vE &apos;(^ *#|^$)&apos; $&#123;CONFIG_FILE&#125; | grep -vE &apos;^ *[0-9]+&apos; &amp;&gt; /dev/null</span><br><span class="line">    if [ $? -eq 0 ]</span><br><span class="line">    then</span><br><span class="line">        echo Error: $&#123;CONFIG_FILE&#125; Contains Invalid Port.</span><br><span class="line">        exit 1</span><br><span class="line">    else</span><br><span class="line">        portarray=($(grep -vE &apos;(^ *#|^$)&apos; $&#123;CONFIG_FILE&#125; | grep -E &apos;^ *[0-9]+&apos;))</span><br><span class="line">    fi</span><br><span class="line">&#125;</span><br><span class="line">PortDiscovery()&#123;</span><br><span class="line">    length=$&#123;#portarray[@]&#125;</span><br><span class="line">    printf &quot;&#123;\n&quot;</span><br><span class="line">    printf  &apos;\t&apos;&quot;\&quot;data\&quot;:[&quot;</span><br><span class="line">    for ((i=0;i&lt;$length;i++))</span><br><span class="line">      do</span><br><span class="line">        printf &apos;\n\t\t&#123;&apos;</span><br><span class="line">        printf &quot;\&quot;&#123;#TCP_PORT&#125;\&quot;:\&quot;$&#123;portarray[$i]&#125;\&quot;&#125;&quot;</span><br><span class="line">        if [ $i -lt $[$length-1] ];then</span><br><span class="line">                    printf &apos;,&apos;</span><br><span class="line">        fi</span><br><span class="line">      done</span><br><span class="line">    printf  &quot;\n\t]\n&quot;</span><br><span class="line">    printf &quot;&#125;\n&quot;</span><br><span class="line">&#125;</span><br><span class="line">port()&#123;</span><br><span class="line">    Check</span><br><span class="line">    PortDiscovery</span><br><span class="line">&#125;</span><br><span class="line">port</span><br></pre></td></tr></table></figure></p>
<p>同目录下编辑port.conf，配置文件port.conf每个端口号一行<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">more port.conf</span><br><span class="line">9551  </span><br><span class="line">9552  </span><br><span class="line">9050  </span><br><span class="line">9052  </span><br><span class="line">7052  </span><br><span class="line">8050  </span><br><span class="line">9053  </span><br><span class="line">5150</span><br></pre></td></tr></table></figure></p>
<p>更改属主<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /etc/zabbix/script/</span><br><span class="line">chown zabbix.zabbix ./*</span><br></pre></td></tr></table></figure></p>
<p>2.修改被监控端的zabbix_agent.conf配置文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/zabbix/zabbix_agentd.conf</span><br><span class="line">UserParameter=port.alert,/etc/zabbix/script/port_check.sh</span><br></pre></td></tr></table></figure></p>
<p>3.重启agent端zabbix服务<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ystemctl restart zabbix-agent</span><br></pre></td></tr></table></figure></p>
<p>4.服务端用zabbix-get看能否获取数据:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@elk-node1 dejavu]#  zabbix_get -s 172.20.100.128 -k port.alert</span><br><span class="line">&#123;</span><br><span class="line">        &quot;data&quot;:[</span><br><span class="line">                &#123;&quot;&#123;#TCP_PORT&#125;&quot;:&quot;9551&quot;&#125;,</span><br><span class="line">                &#123;&quot;&#123;#TCP_PORT&#125;&quot;:&quot;9552&quot;&#125;,</span><br><span class="line">                &#123;&quot;&#123;#TCP_PORT&#125;&quot;:&quot;9050&quot;&#125;,</span><br><span class="line">                &#123;&quot;&#123;#TCP_PORT&#125;&quot;:&quot;9052&quot;&#125;,</span><br><span class="line">                &#123;&quot;&#123;#TCP_PORT&#125;&quot;:&quot;7052&quot;&#125;,</span><br><span class="line">                &#123;&quot;&#123;#TCP_PORT&#125;&quot;:&quot;8050&quot;&#125;,</span><br><span class="line">                &#123;&quot;&#123;#TCP_PORT&#125;&quot;:&quot;9053&quot;&#125;,</span><br><span class="line">                &#123;&quot;&#123;#TCP_PORT&#125;&quot;:&quot;5150&quot;&#125;</span><br><span class="line">        ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>5.接下来就在zabbix管理web添加自动发现规则：配置在默认的模板Template OS Linux里即可<br>添加自动发现规则：<br><img src="https://raw.githubusercontent.com/yangzhij/myself-images/master/zaPort1.png" alt="https://raw.githubusercontent.com/yangzhij/myself-images/master/zaPort1.png"><br><img src="https://raw.githubusercontent.com/yangzhij/myself-images/master/zaPort2.png" alt="https://raw.githubusercontent.com/yangzhij/myself-images/master/zaPort2.png"><br><img src="https://raw.githubusercontent.com/yangzhij/myself-images/master/zaPort3.png" alt="https://raw.githubusercontent.com/yangzhij/myself-images/master/zaPort3.png"><br>之后点击刚创建的自动发现规则tcp port discover，开始添加监控项原型<br><img src="https://raw.githubusercontent.com/yangzhij/myself-images/master/zaPort4.png" alt="https://raw.githubusercontent.com/yangzhij/myself-images/master/zaPort4.png"><br><img src="https://raw.githubusercontent.com/yangzhij/myself-images/master/zaPort5.png" alt="https://raw.githubusercontent.com/yangzhij/myself-images/master/zaPort5.png"><br>完毕之后，添加触发器报警：值为0则端口不通，值为1则端口通<br><img src="https://raw.githubusercontent.com/yangzhij/myself-images/master/zaPort6.png" alt="https://raw.githubusercontent.com/yangzhij/myself-images/master/zaPort6.png"><br><img src="https://raw.githubusercontent.com/yangzhij/myself-images/master/zaPort7.png" alt="https://raw.githubusercontent.com/yangzhij/myself-images/master/zaPort7.png"><br>完成之后，可以再弄个图形原型<br><img src="https://raw.githubusercontent.com/yangzhij/myself-images/master/zaPort8.png" alt="https://raw.githubusercontent.com/yangzhij/myself-images/master/zaPort8.png"><br>添加完之后等一会儿图就会生成了，如下图所示。然后可以测试这关闭几个进程来验证。<br><img src="https://raw.githubusercontent.com/yangzhij/myself-images/master/zaPort9.png" alt="https://raw.githubusercontent.com/yangzhij/myself-images/master/zaPort9.png"></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/02/09/Mongodb副本集/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="yangzhijun">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://raw.githubusercontent.com/yangzhij/images2/master/1.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yangzhijun">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/02/09/Mongodb副本集/" itemprop="url">Mongodb副本集</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-02-09T20:47:04+08:00">
                2019-02-09
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong>replication set</strong>： 副本集，多台服务器维护相同的数据副本，提高服务器的可用性.<br>最小的副本集也应该具备一个primary节点和两个secondary节点。两个节点的副本集不具备真正的故障转移能力。</p>
<p><strong>整个流程说明：</strong><br> 本次是在一台机器上启动了3个实例进行模拟测试，区别于端口。副本集完成之后，27017是primary，27018和27019为Secondary。在27017上插入数据，27018和27019都可以读到。 把27017停掉之后，27018会从Secondary变成primary。27019还是Secondary。在27018上插入数据，27019也可以读到。当27017重新起来后，会从原来的primary变成Secondary，数据也会同步的。</p>
<p><strong>注意：</strong><br>当副本集中所有的Secondary都宕机、或者副本集中只剩下一个节点，则该节点只会成为Secondary节点（即使是primary节点也只能降级为secondary节点），也就意味着整个集群此时只能进行读操作而不能进行写操作，当其他节点恢复之后，之前的primary节点仍然是primary节点。<strong>默认情况下，Secondary是不提供服务的，即不能读和写。在特殊情况下需要读的话则需要：rs.slaveOk()，只对当前连接有效。</strong></p>
<p><strong>//下载</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local</span><br><span class="line">wget https://fastdl.mongodb.org/linux/mongodb-linux-x86_64-rhel70-4.0.4.tgz</span><br><span class="line">tar xvf mongodb-linux-x86_64-rhel70-4.0.4.tgz</span><br><span class="line">mv mongodb-linux-x86_64-rhel70-4.0.4 mongodb</span><br></pre></td></tr></table></figure></p>
<p><strong>//创建目录</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /home/m17 /home/m18 /home/m19 /home/mlog</span><br></pre></td></tr></table></figure></p>
<p><strong>//启动实例，且声明实例属于某复制集。  本次是在一台机器上启动了3个实例，区别于端口。实际生产中可以3台机器各自启动一个，端口可以都是27017。</strong><br>说明：启动MongoDB有2种方式，一是直接指定配置参数，二是指定配置文件。本次通过指定配置参数启动：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">//启动</span><br><span class="line">/usr/local/mongodb/bin/mongod --dbpath /home/m17 --logpath /home/mlog/m17.log --port 27017 --bind_ip 0.0.0.0 --fork --smallfiles --replSet rs2</span><br><span class="line">/usr/local/mongodb/bin/mongod --dbpath /home/m18 --logpath /home/mlog/m18.log --port 27018 --bind_ip 0.0.0.0 --fork --smallfiles --replSet rs2</span><br><span class="line">/usr/local/mongodb/bin/mongod --dbpath /home/m19 --logpath /home/mlog/m19.log --port 27019 --bind_ip 0.0.0.0 --fork --smallfiles --replSet rs2</span><br><span class="line">//参数说明</span><br><span class="line">--dbpath             #存放数据的路径</span><br><span class="line">--logpath            #存放日志的路径</span><br><span class="line">--bind_ip            #绑定ip。默认127.0.0.1，只能通过本地连接。</span><br><span class="line">--fork               #后台启动</span><br><span class="line">--smallfiles         #使用较小的默认数据文件大小。</span><br><span class="line">--replSet rs2        #指定一个副本集名称rs2作为参数，所有主机都必须有相同的名称作为同一个副本集。</span><br></pre></td></tr></table></figure></p>
<p><strong>//初始化</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/mongodb/bin/</span><br><span class="line">./mongo</span><br><span class="line">&gt; rs.initiate(&#123;&quot;_id&quot;:&quot;rs2&quot;,&quot;members&quot;:[</span><br><span class="line">&#123;&quot;_id&quot;:0,</span><br><span class="line">&quot;host&quot;:&quot;172.20.100.219:27017&quot;,</span><br><span class="line">&quot;priority&quot;:1</span><br><span class="line">&#125;,</span><br><span class="line">&#123;&quot;_id&quot;:1,</span><br><span class="line">&quot;host&quot;:&quot;172.20.100.219:27018&quot;,</span><br><span class="line">&quot;priority&quot;:1</span><br><span class="line">&#125;,</span><br><span class="line">&#123;&quot;_id&quot;:2,</span><br><span class="line">&quot;host&quot;:&quot;172.20.100.219:27019&quot;,</span><br><span class="line">&quot;priority&quot;:1</span><br><span class="line">&#125;</span><br><span class="line">]&#125;)</span><br></pre></td></tr></table></figure></p>
<p><strong>//主节点PRIMARY插入数据测试</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">//测试1</span><br><span class="line">rs2:PRIMARY&gt; use test</span><br><span class="line">rs2:PRIMARY&gt; db.user.insert(&#123;uid:1,name:&apos;lily&apos;&#125;);</span><br><span class="line">rs2:PRIMARY&gt; db.user.find()</span><br><span class="line"></span><br><span class="line">//测试2</span><br><span class="line">rs2:PRIMARY&gt; for(var i=0;i&lt;10000;i++)&#123;db.test.insert(&#123;&quot;name&quot;:&quot;test&quot;+i,&quot;age&quot;:123&#125;)&#125;</span><br><span class="line">rs2:PRIMARY&gt; db.test.count()</span><br></pre></td></tr></table></figure></p>
<p><strong>//在Secondary上查看是否已经同步</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">//测试1</span><br><span class="line">rs2:SECONDARY&gt; rs.slaveOk()</span><br><span class="line">rs2:SECONDARY&gt; db.user.find()</span><br><span class="line">//测试2</span><br><span class="line">rs2:SECONDARY&gt; rs.slaveOk()</span><br><span class="line">rs2:SECONDARY&gt; db.test.count()</span><br></pre></td></tr></table></figure></p>
<p><strong>增删节点，注意：增删节点都在PRIMARY节点执行</strong><br>//添加节点到副本集<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rs2:PRIMARY&gt; rs.add(&quot;172.20.100.219:27016&quot;)</span><br><span class="line"></span><br><span class="line">rs2:PRIMARY&gt; rs.status()  //查看副本集的状态</span><br></pre></td></tr></table></figure></p>
<p>//从副本集移除某节点<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rs2:PRIMARY&gt; rs.remove(&quot;172.20.100.219:27016&quot;)</span><br><span class="line">rs2:PRIMARY&gt; rs.status()  //查看副本集的状态</span><br></pre></td></tr></table></figure></p>
<p><strong>手动切换Primary节点到自己给定的节点</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">rs2:PRIMARY&gt; rs.conf()   #查看配置</span><br><span class="line"></span><br><span class="line">&quot;_id&quot; : &quot;rs2&quot;,       副本集名称</span><br><span class="line">&quot;version&quot; : 7,       每改变一次集群的配置，副本集的version都会加1</span><br><span class="line">...</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">members里面其中一个参数：</span><br><span class="line">priority  ：优先集，因为最开始默认的都是1，只需要把给定的服务器的priority加到这些主机中最大的即可。</span><br><span class="line"></span><br><span class="line">rs2:PRIMARY&gt; rs.status() #查看状态</span><br><span class="line"></span><br><span class="line">rs2:PRIMARY&gt; cfg=rs.conf()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">rs2:PRIMARY&gt; cfg.members[1].priority=2  #修改priority         [1] 相当于python里面的下标，更改第几台主机的priority=2，从0开始算第一台</span><br><span class="line">rs2:PRIMARY&gt; rs.reconfig(cfg)           #重新加载配置文件，强制副本集进行一次选举，优先级高的成为Primary。在这期间整个集群的所有节点都是secondary。</span><br><span class="line"></span><br><span class="line">rs2:PRIMARY&gt; rs.status()      #查看状态，更改完后需要等一下才能生效，所以第一遍查看状态看不出来，多查看两次就出来效果了。</span><br></pre></td></tr></table></figure></p>
<p><strong>//添加仲裁节点  “stateStr” : “ARBITER”</strong>(4版本开始已经没有必要了)<br>副本集要求参与选举投票(vote)的节点数为奇数，为了实现 Automatic Failover（自动故障转移）引入另一类节点：仲裁者（arbiter），仲裁者只参与投票不拥有实际的数据，并且不提供任何服务，因此它对物理资源要求不严格。</p>
<p><strong>测试发现</strong>，当整个副本集集群中达到50%的节点（包括仲裁节点）不可用的时候，剩下的节点只能成为secondary节点，整个集群只能读不能写。<br>当集群中有1个primary节点，1个secondary节点和1个arbiter节点，这时即使 primary节点挂了，剩下的secondary节点也会自动成为primary节点。<br>因为仲裁节点不复制数据，因此<strong>利用仲裁节点可以实现最少的机器开销达到两个节点热备的效果。</strong></p>
<p><strong>如果要把之前的某一节点变成仲裁节点，则需要：</strong><br>1.先从副本集中移除该节点<br>2.杀掉该进程<br>3.删除该节点的数据目录和日志目录<br>4.重新创建好数据目录<br>5.重新启动然后添加到副本集rs.addArb(“172.20.100.219:27019”)</p>
<p><strong>//运行rs.status()发现某从节点statestr一直是STARTUP2，处理如下：</strong><br>1.先从副本集中移除该节点<br>2.杀掉该进程<br>3.删除该节点的数据目录和日志目录<br>4.重新创建好数据目录<br>5.重新启动然后添加到副本集</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/02/06/rabbitMQ集群/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="yangzhijun">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="https://raw.githubusercontent.com/yangzhij/images2/master/1.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="yangzhijun">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/02/06/rabbitMQ集群/" itemprop="url">rabbitMQ集群</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-02-06T11:43:16+08:00">
                2019-02-06
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>rabbitmq：消息队列。作为消息中间件，一般以集群方式部署，主要提供消息的接受和发送，实现各服务之间的消息异步。</p>
<p>原理：<br>RabbitMQ底层是通过Erlang架构来实现的。RabbitMQ底层是通过Erlang架构来实现的，所以rabbitmqctl会启动Erlang节点，并基于Erlang节点来使用Erlang系统连接RabbitMQ节点，在连接过程中需要正确的Erlang Cookie和节点名称，<br>Erlang节点通过交换Erlang Cookie以获得认证。<br>所以部署rabbitmq分布式集群时要先安装erlang，并把其中一个服务的cookie复制到另外的节点。</p>
<p>rabbitmq集群中，各个rabbitmq为对等节点，即每个节点均提供给客户端连接，进行消息的接收和发送。<br>节点分为内存节点和磁盘节点，一般的，为了防止机器重启后的消息消失，均应建立为磁盘节点；</p>
<p>RabbitMQ的Cluster集群模式一般分为两种，普通模式和镜像模式。</p>
<p>1.必备工具安装<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install vim wget ntp lrzsz</span><br></pre></td></tr></table></figure></p>
<p>2.确定3台主机的时间同步<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">yum -y install chrony</span><br><span class="line">timedatectl set-timezone Asia/Shanghai</span><br><span class="line">systemctl enable chronyd.service</span><br><span class="line">systemctl start chronyd.service</span><br><span class="line">hwclock --systohc</span><br></pre></td></tr></table></figure></p>
<p>3.配置3台机器的/etc/hosts文件: 在/etc/hosts中，绑定三台机器的ip和主机名（erlang是通过主机名来连接服务，必须保证各个主机名之间可以ping通。如果主机名ping不通，rabbitmq服务启动会失败。）<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/hosts 添加（注意中间空格为tab符号）</span><br><span class="line">192.168.0.101 rabbitmq-1</span><br><span class="line">192.168.0.102 rabbitmq-2</span><br><span class="line">192.168.0.103 rabbitmq-3</span><br><span class="line">scp /etc/hosts root@192.168.0.102:/etc/hosts      拷贝到其他机器</span><br><span class="line">scp /etc/hosts root@192.168.0.103:/etc/hosts</span><br></pre></td></tr></table></figure></p>
<p>4.分别在3台上面执行安装<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">yum -y install gcc glibc-devel make ncurses-devel openssl-devel xmlto perl wget</span><br><span class="line">wget http://www.rabbitmq.com/releases/erlang/erlang-19.0.4-1.el6.x86_64.rpm</span><br><span class="line">rpm -ivh erlang-19.0.4-1.el6.x86_64.rpm</span><br><span class="line">wget https://dl.bintray.com/rabbitmq/rabbitmq-server-rpm/rabbitmq-server-3.6.12-1.el6.noarch.rpm</span><br><span class="line">rpm --import https://www.rabbitmq.com/rabbitmq-release-signing-key.asc</span><br><span class="line">yum -y makecache</span><br><span class="line">yum -y install socat</span><br><span class="line">rpm -ivh rabbitmq-server-3.6.12-1.el6.noarch.rpm</span><br></pre></td></tr></table></figure></p>
<p>5.<strong>erlang.cookie是erlang实现分布式的必要文件，erlang分布式的每个节点上要保持相同的。</strong>同时要保证cookie文件的权限是400,不然节点之间就无法通信。打开rabbitmq-1服务器的/var/lib/rabbitmq/.erlang.cookie中的内容,复制到其他节点上。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /var/lib/rabbitmq/</span><br><span class="line">scp .erlang.cookie root@192.168.0.102:/var/lib/rabbitmq/</span><br></pre></td></tr></table></figure></p>
<p>6.系统调优<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">文件末尾添加下面4行</span><br><span class="line">vi /etc/security/limits.conf</span><br><span class="line">* soft nofile 102400</span><br><span class="line">* hard nofile 102400</span><br><span class="line"></span><br><span class="line">* soft nproc 102400</span><br><span class="line">* hard nproc 102400</span><br><span class="line"></span><br><span class="line">//文件末未添加</span><br><span class="line">vi /etc/sysctl.conf</span><br><span class="line">fs.file-max=102400</span><br><span class="line"></span><br><span class="line">//可以打开的最大文件数量及用户最大可用的进程数</span><br><span class="line">ulimit -n 65000</span><br><span class="line">ulimit -u 65000</span><br></pre></td></tr></table></figure></p>
<p>7.分别启动<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">//启动并查看状态</span><br><span class="line">systemctl start rabbitmq-server.service</span><br><span class="line">systemctl status rabbitmq-server.service</span><br><span class="line"></span><br><span class="line">//开启网页管理插件</span><br><span class="line">rabbitmq-plugins enable rabbitmq_management</span><br><span class="line">systemctl restart rabbitmq-server.service</span><br></pre></td></tr></table></figure></p>
<p>8.集群节点添加（添加新节点）<br>将rabbit@rabbitmq-1作为集群主节点，在其他节点上分别执行如下命令，以加入集群中.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">rabbitmqctl stop_app                            # 仅停止应用</span><br><span class="line">rabbitmqctl reset                                # 重置应用</span><br><span class="line">rabbitmqctl join_cluster rabbit@rabbitmq-1           # 加入rabbit@rabbitmq-1集群</span><br><span class="line">rabbitmqctl start_app                            # 开启应用</span><br><span class="line">rabbitmqctl cluster_status                        # 都查看集群状态</span><br></pre></td></tr></table></figure></p>
<p>9.账号管理<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">rabbitmqctl add_user admin admin                # 添加账号</span><br><span class="line">rabbitmqctl set_user_tags admin administrator    # 添加权限</span><br><span class="line">rabbitmqctl delete_user guest                    # 删除用户</span><br><span class="line">rabbitmqctl change_password 用户名 密码            # 修改用户的密码</span><br><span class="line">rabbitmqctl list_users                            # 查看当前用户列表</span><br><span class="line"></span><br><span class="line">//vhost管理</span><br><span class="line">rabbitmqctl add_vhost vhostname        # 创建vhost</span><br><span class="line">rabbitmqctl delete_vhost vhostname     # 删除vhost</span><br><span class="line">rabbitmqctl list_vhosts                # 查看所有虚拟主机信息</span><br><span class="line">rabbitmqctl set_permissions -p v_host user  &quot;.*&quot;  &quot;.*&quot;  &quot;.*&quot;   ##绑定权限，并且具备读写的权限</span><br><span class="line">rabbitmqctl list_queues                # 显示所有队列</span><br></pre></td></tr></table></figure></p>
<p>10.分别在3台主机上查看连接的状态<br>rabbitmqctl cluster_status</p>
<p>–第一行是集群中的节点成员，disc表示这些都是磁盘节点。<br>–第二行是正在运行的节点成员</p>
<p>11.节点退出集群(从集群中移除节点)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">假设要把rabbitmq-2退出集群，在rabbitmq2上执行</span><br><span class="line">#rabbitmqctl stop_app</span><br><span class="line">#rabbitmqctl reset</span><br><span class="line">#rabbitmqctl start_app</span><br><span class="line"></span><br><span class="line">然后在集群主节点上执行</span><br><span class="line"># rabbitmqctl forget_cluster_rabbitmq rabbit@rabbitmq-2</span><br></pre></td></tr></table></figure></p>
<p>12.可以删除默认guest用户<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rabbitmqctl delete_user guest</span><br></pre></td></tr></table></figure></p>
<p>haproxy 对mq进行负载<br>keepalive    提供统一入口，防止单点故障</p>
<p><strong>安装keepalived，提供一个入口</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum -y install keepalived </span><br><span class="line">systemctl enable keepalived</span><br><span class="line">systemctl start keepalived</span><br></pre></td></tr></table></figure></p>
<p>分别编辑三台的配置文件vim /etc/keepalived/keepalived.conf，内容如下：priority 分别为101,102,103<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">vrrp_script chk_haproxy &#123;</span><br><span class="line">    script &quot;/usr/sbin/pidof haproxy&quot;</span><br><span class="line">    interval 2</span><br><span class="line">&#125;</span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    interface eth0</span><br><span class="line">    state BACKUP</span><br><span class="line">    nopreempt</span><br><span class="line">    priority 101</span><br><span class="line">    virtual_router_id 10</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass password</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        172.20.100.30</span><br><span class="line">    &#125;</span><br><span class="line">    track_script &#123;</span><br><span class="line">        chk_haproxy</span><br><span class="line">    &#125;</span><br><span class="line">    notify_master /etc/keepalived/check_haproxy.sh</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>//编辑检测脚本，为了防止haproxy服务关闭导致keepalived不自动切换<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/keepalived/check_haproxy.sh</span><br><span class="line">#!/bin/bash</span><br><span class="line">if [ $(ps -C haproxy --no-header | wc -l) -eq 0 ]; then</span><br><span class="line">       systemctl start haproxy</span><br><span class="line">fi</span><br><span class="line">sleep 2</span><br><span class="line">if [ $(ps -C haproxy --no-header | wc -l) -eq 0 ]; then</span><br><span class="line">       systemctl stop keepalived</span><br><span class="line">fi</span><br></pre></td></tr></table></figure></p>
<p>//重启启动<br>systemctl restart keepalived</p>
<p><strong>haproxy搭建</strong><br>//安装<br>yum -y install haproxy</p>
<p>//配置haproxy<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">#vim /etc/haproxy/haproxy.cfg       //在末尾添加以下内容</span><br><span class="line"></span><br><span class="line">#---------------------------------------------------------------------</span><br><span class="line">listen rabbitmq_admin</span><br><span class="line">    bind 0.0.0.0:15673</span><br><span class="line">    mode tcp</span><br><span class="line">    balance roundrobin</span><br><span class="line">    option tcpka</span><br><span class="line">    option tcplog</span><br><span class="line">    timeout client 3h</span><br><span class="line">    timeout server 3h</span><br><span class="line">    timeout connect 3h</span><br><span class="line">    server mqnode1 192.168.0.101:15672</span><br><span class="line">    server mqnode2 192.168.0.102:15672</span><br><span class="line">    server mqnode3 192.168.0.103:15672</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">listen rabbitmq_cluster 0.0.0.0:5673</span><br><span class="line">    mode tcp</span><br><span class="line"></span><br><span class="line">    balance roundrobin</span><br><span class="line">    option tcpka</span><br><span class="line">    option tcplog</span><br><span class="line">    timeout client 3h</span><br><span class="line">    timeout server 3h</span><br><span class="line">    timeout connect 3h</span><br><span class="line"></span><br><span class="line">    server   mqnode1 192.168.0.101:5672 check inter 5s rise 2 fall 3</span><br><span class="line">    server   mqnode2 192.168.0.102:5672 check inter 5s rise 2 fall 3</span><br><span class="line">    server   mqnode3 192.168.0.103:5672 check inter 5s rise 2 fall 3</span><br></pre></td></tr></table></figure></p>
<p>//启动<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl start haproxy</span><br></pre></td></tr></table></figure></p>
<p><strong>镜像模式</strong>：把需要的队列做成镜像队列，存在于多个节点，属于RabbitMQ的HA方案，在任意节点上执行<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rabbitmqctl set_policy ha-all &quot;hello&quot; &apos;&#123;&quot;ha-mode&quot;:&quot;all&quot;&#125;&apos;</span><br></pre></td></tr></table></figure></p>
<p>hello 是同步的队列名，可以用正则表达式匹配；<br>{“ha-mode”:”all”} 表示同步给所有</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="https://raw.githubusercontent.com/yangzhij/images2/master/1.jpg" alt="yangzhijun">
            
              <p class="site-author-name" itemprop="name">yangzhijun</p>
              <p class="site-description motion-element" itemprop="description">愿一生温暖纯良</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">59</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            

            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="undefined" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-globe"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="undefined" target="_blank" title="Boke">
                      
                        <i class="fa fa-fw fa-globe"></i>Boke</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">yangzhijun</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

  
  
</body>
</html>
